<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>SpringBoot：雷神笔记(高级) | Somuns ` Tao</title><meta name="description" content="you can &quot;just run&quot;"><meta name="keywords" content="spring"><meta name="author" content="陈涛"><meta name="copyright" content="陈涛"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="SpringBoot：雷神笔记(高级)"><meta name="twitter:description" content="you can &quot;just run&quot;"><meta name="twitter:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><meta property="og:type" content="article"><meta property="og:title" content="SpringBoot：雷神笔记(高级)"><meta property="og:url" content="https://somunstao.github.io/2020/03/30/SpringBoot22%EF%BC%9A%E9%9B%B7%E7%A5%9E%E7%AC%94%E8%AE%B0%E9%AB%98%E7%BA%A7/"><meta property="og:site_name" content="Somuns ` Tao"><meta property="og:description" content="you can &quot;just run&quot;"><meta property="og:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><meta property="article:published_time" content="2020-03-29T16:00:00.000Z"><meta property="article:modified_time" content="2020-05-03T08:28:21.154Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://somunstao.github.io/2020/03/30/SpringBoot22%EF%BC%9A%E9%9B%B7%E7%A5%9E%E7%AC%94%E8%AE%B0%E9%AB%98%E7%BA%A7/"><link rel="prev" title="SpringBoot：小总结" href="https://somunstao.github.io/2020/03/30/SpringBoot20%EF%BC%9A%E5%B0%8F%E6%80%BB%E7%BB%93/"><link rel="next" title="SpringBoot：雷神笔记" href="https://somunstao.github.io/2020/03/30/SpringBoot22%EF%BC%9A%E9%9B%B7%E7%A5%9E%E7%AC%94%E8%AE%B0(%E5%88%9D%E7%BA%A7)/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: true,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Somuns ` Tao" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">85</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">10</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 時間軸</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 留言板</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#springboot高级"><span class="toc-number">1.</span> <span class="toc-text">springboot高级</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#一-Spring-Boot与缓存"><span class="toc-number">2.</span> <span class="toc-text">(一) Spring Boot与缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、-JSR107"><span class="toc-number">2.1.</span> <span class="toc-text">一、 JSR107</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、-Spring缓存抽象"><span class="toc-number">2.2.</span> <span class="toc-text">二、 Spring缓存抽象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、-重要缓存注解及概念"><span class="toc-number">2.3.</span> <span class="toc-text">三、 重要缓存注解及概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Cacheable-CachePut-CacheEvict-主要的参数"><span class="toc-number">2.3.1.</span> <span class="toc-text">1 . @Cacheable&#x2F;@CachePut&#x2F;@CacheEvict 主要的参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-缓存可用的SpEL表达式"><span class="toc-number">2.3.2.</span> <span class="toc-text">2 . 缓存可用的SpEL表达式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、-缓存使用"><span class="toc-number">2.4.</span> <span class="toc-text">四、 缓存使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-基本使用步骤"><span class="toc-number">2.4.1.</span> <span class="toc-text">1. 基本使用步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-搭建实验环境"><span class="toc-number">2.4.2.</span> <span class="toc-text">2. 搭建实验环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-快速体验缓存"><span class="toc-number">2.4.3.</span> <span class="toc-text">3. 快速体验缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-工作原理"><span class="toc-number">2.4.4.</span> <span class="toc-text">4. 工作原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、Redis与缓存"><span class="toc-number">2.5.</span> <span class="toc-text">五、Redis与缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-环境搭建"><span class="toc-number">2.5.1.</span> <span class="toc-text">1. 环境搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-RedisTemplate"><span class="toc-number">2.5.2.</span> <span class="toc-text">2. RedisTemplate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Redis缓存使用"><span class="toc-number">2.5.3.</span> <span class="toc-text">3. Redis缓存使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Redis缓存原理"><span class="toc-number">2.5.4.</span> <span class="toc-text">4. Redis缓存原理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#二-Spring-Boot与消息"><span class="toc-number">3.</span> <span class="toc-text">(二) Spring Boot与消息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、消息简介"><span class="toc-number">3.1.</span> <span class="toc-text">一、消息简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、RabbitMQ"><span class="toc-number">3.2.</span> <span class="toc-text">二、RabbitMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-核心概念"><span class="toc-number">3.2.1.</span> <span class="toc-text">1. 核心概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-运行机制"><span class="toc-number">3.2.2.</span> <span class="toc-text">2. 运行机制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、-Springboot中的RabbitMQ"><span class="toc-number">3.3.</span> <span class="toc-text">三、 Springboot中的RabbitMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-环境准备"><span class="toc-number">3.3.1.</span> <span class="toc-text">1. 环境准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-RabbitMQ的使用"><span class="toc-number">3.3.2.</span> <span class="toc-text">2. RabbitMQ的使用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#三-Spring-boot与检索"><span class="toc-number">4.</span> <span class="toc-text">(三) Spring boot与检索</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、-ElasticSearch入门"><span class="toc-number">4.1.</span> <span class="toc-text">一、 ElasticSearch入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-ES的简介"><span class="toc-number">4.1.1.</span> <span class="toc-text">1. ES的简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-ES的安装与运行"><span class="toc-number">4.1.2.</span> <span class="toc-text">2. ES的安装与运行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-ES的基础入门"><span class="toc-number">4.1.3.</span> <span class="toc-text">3. ES的基础入门</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、-Springboot整合ElasticSearch"><span class="toc-number">4.2.</span> <span class="toc-text">二、 Springboot整合ElasticSearch</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-概述"><span class="toc-number">4.2.1.</span> <span class="toc-text">1. 概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-环境搭建"><span class="toc-number">4.2.2.</span> <span class="toc-text">2. 环境搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-ElasticSearch客户端"><span class="toc-number">4.2.3.</span> <span class="toc-text">3. ElasticSearch客户端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-ElasticsearchRestTemplate"><span class="toc-number">4.2.4.</span> <span class="toc-text">4. ElasticsearchRestTemplate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-Elasticsearch-Repositories"><span class="toc-number">4.2.5.</span> <span class="toc-text">5. Elasticsearch Repositories</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#四-Spring-boot与任务"><span class="toc-number">5.</span> <span class="toc-text">(四) Spring boot与任务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、异步任务"><span class="toc-number">5.1.</span> <span class="toc-text">一、异步任务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、-定时任务"><span class="toc-number">5.2.</span> <span class="toc-text">二、 定时任务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、-邮件任务"><span class="toc-number">5.3.</span> <span class="toc-text">三、 邮件任务</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#五-Spring-boot与安全"><span class="toc-number">6.</span> <span class="toc-text">(五) Spring boot与安全</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、安全"><span class="toc-number">6.1.</span> <span class="toc-text">一、安全</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、Spring-Security"><span class="toc-number">6.2.</span> <span class="toc-text">二、Spring Security</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、-Springboot整合security"><span class="toc-number">6.3.</span> <span class="toc-text">三、 Springboot整合security</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-导入依赖"><span class="toc-number">6.3.1.</span> <span class="toc-text">1. 导入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-登录-注销"><span class="toc-number">6.3.2.</span> <span class="toc-text">2. 登录&#x2F;注销</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-定义认证规则"><span class="toc-number">6.3.3.</span> <span class="toc-text">3. 定义认证规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-自定义欢迎页"><span class="toc-number">6.3.4.</span> <span class="toc-text">4.自定义欢迎页</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-自定义登录页-记住我"><span class="toc-number">6.3.5.</span> <span class="toc-text">5. 自定义登录页&#x2F;记住我</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#六-Spring-boot与分布式"><span class="toc-number">7.</span> <span class="toc-text">(六) Spring boot与分布式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、分布式应用"><span class="toc-number">7.1.</span> <span class="toc-text">一、分布式应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、Zookeeper和Dubbo"><span class="toc-number">7.2.</span> <span class="toc-text">二、Zookeeper和Dubbo</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-概述-1"><span class="toc-number">7.2.1.</span> <span class="toc-text">1. 概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-整合springboot"><span class="toc-number">7.2.2.</span> <span class="toc-text">2. 整合springboot</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、Spring-Cloud"><span class="toc-number">7.3.</span> <span class="toc-text">三、Spring Cloud</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-概述-2"><span class="toc-number">7.3.1.</span> <span class="toc-text">1. 概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-入门"><span class="toc-number">7.3.2.</span> <span class="toc-text">2. 入门</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#七-Spring-boot与热部署"><span class="toc-number">8.</span> <span class="toc-text">(七) Spring boot与热部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、模板引擎"><span class="toc-number">8.1.</span> <span class="toc-text">一、模板引擎</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、Spring-Loaded"><span class="toc-number">8.2.</span> <span class="toc-text">二、Spring Loaded</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、JRebel"><span class="toc-number">8.3.</span> <span class="toc-text">三、JRebel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、-Spring-Boot-Devtools（推荐）"><span class="toc-number">8.4.</span> <span class="toc-text">四、 Spring Boot Devtools（推荐）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#八-Spring-Boot与监控管理"><span class="toc-number">9.</span> <span class="toc-text">(八) Spring Boot与监控管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、-Actuator监控管理"><span class="toc-number">9.1.</span> <span class="toc-text">一、 Actuator监控管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、-端点配置"><span class="toc-number">9.2.</span> <span class="toc-text">二、 端点配置</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Somuns ` Tao</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 時間軸</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 留言板</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">SpringBoot：雷神笔记(高级)</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-03-30 00:00:00"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-03-30</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-05-03 16:28:21"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-05-03</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/SpringBoot/">SpringBoot</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><p><img src="https://niceseason.github.io/images/OG-Spring.png" alt="springboot高级"></p>
<h1 id="springboot高级"><a href="#springboot高级" class="headerlink" title="springboot高级"></a>springboot高级</h1><hr>
<p>本文分别从缓存、消息、检索、任务、安全、分布式、热部署和监控管理方面，对spring boot高级部分做了简单总结，内容不深但覆盖全。</p>
<h1 id="一-Spring-Boot与缓存"><a href="#一-Spring-Boot与缓存" class="headerlink" title="(一) Spring Boot与缓存"></a>(一) Spring Boot与缓存</h1><h2 id="一、-JSR107"><a href="#一、-JSR107" class="headerlink" title="一、 JSR107"></a>一、 JSR107</h2><p>Java Caching定义了5个核心接口</p>
<ul>
<li><p>CachingProvider</p>
<p>定义了创建、配置、获取、管理和控制多个CacheManager。一个应用可<br>以在运行期访问多个CachingProvider。</p>
</li>
<li><p>CacheManager</p>
<p>定义了创建、配置、获取、管理和控制多个唯一命名的Cache，这些Cache<br>存在于CacheManager的上下文中。一个CacheManager仅被一个CachingProvider所拥有。</p>
</li>
<li><p>Cache</p>
<p>一个类似<strong>Map</strong>的数据结构并<strong>临时存储以Key为索引</strong>的值。一个Cache仅被一个<br>CacheManager所拥有。</p>
</li>
<li><p>Entry</p>
<p>一个存储在Cache中的key-value对。</p>
</li>
<li><p>Expiry</p>
<p>每一个存储在Cache中的条目有一个定义的有效期。一旦超过这个时间，条目为过期的状态。一旦过期，条目将不可访问、更新和删除。缓存有效期可以通过ExpiryPolicy设置。</p>
<p><a href="https://niceseason.github.io/images/图片1.png" target="_blank" rel="noopener"><img src="https://niceseason.github.io/images/%E5%9B%BE%E7%89%871.png" alt="jsr107示意图"></a></p>
<p><a href="https://niceseason.github.io/images/图片1.png" target="_blank" rel="noopener">jsr107示意图</a></p>
</li>
</ul>
<h2 id="二、-Spring缓存抽象"><a href="#二、-Spring缓存抽象" class="headerlink" title="二、 Spring缓存抽象"></a>二、 Spring缓存抽象</h2><p>  Spring从3.1开始定义了org.springframework.cache.Cache<br>  和org.springframework.cache.CacheManager接口来<strong>统一</strong>不同的缓存技术；<br>  <strong>并支持使用JCache（JSR-107）</strong>注解简化我们开发；</p>
<p>  Cache接口有以下功能：</p>
<ul>
<li>为缓存的组件规范定义，包含缓存的各种操作集合；</li>
</ul>
<ul>
<li><p>Spring提供了各种xxxCache的实现；如RedisCache，EhCacheCache ,<br>ConcurrentMapCache等；</p>
<p><a href="https://niceseason.github.io/images/图片2.png" target="_blank" rel="noopener"><img src="https://niceseason.github.io/images/%E5%9B%BE%E7%89%872.png" alt="Spring缓存抽象"></a></p>
<p><a href="https://niceseason.github.io/images/图片2.png" target="_blank" rel="noopener">Spring缓存抽象</a></p>
</li>
</ul>
<h2 id="三、-重要缓存注解及概念"><a href="#三、-重要缓存注解及概念" class="headerlink" title="三、 重要缓存注解及概念"></a>三、 重要缓存注解及概念</h2><table>
<thead>
<tr>
<th><strong>Cache</strong></th>
<th align="left"><strong>缓存接口，定义缓存操作。实现有：RedisCache、EhCacheCache、ConcurrentMapCache等</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>CacheManager</strong></td>
<td align="left"><strong>缓存管理器，管理各种缓存（Cache）组件</strong></td>
</tr>
<tr>
<td><strong>@Cacheable</strong></td>
<td align="left"><strong>根据方法的请求参数对其结果进行缓存</strong></td>
</tr>
<tr>
<td><strong>@CacheEvict</strong></td>
<td align="left"><strong>清空缓存</strong></td>
</tr>
<tr>
<td><strong>@CachePut</strong></td>
<td align="left"><strong>更新缓存</strong></td>
</tr>
<tr>
<td><strong>@EnableCaching</strong></td>
<td align="left"><strong>开启基于注解的缓存</strong></td>
</tr>
<tr>
<td><strong>keyGenerator</strong></td>
<td align="left"><strong>缓存数据时key生成策略</strong></td>
</tr>
<tr>
<td><strong>serialize</strong></td>
<td align="left"><strong>缓存数据时value序列化策略</strong></td>
</tr>
</tbody></table>
<h3 id="1-Cacheable-CachePut-CacheEvict-主要的参数"><a href="#1-Cacheable-CachePut-CacheEvict-主要的参数" class="headerlink" title="1 . @Cacheable/@CachePut/@CacheEvict 主要的参数"></a>1 . @Cacheable/@CachePut/@CacheEvict 主要的参数</h3><ul>
<li><p><strong>value</strong></p>
<p>缓存名称，字符串/字符数组形式；</p>
<p>如@Cacheable(value=”mycache”) 或者@Cacheable(value={”cache1”,”cache2”}</p>
</li>
<li><p><strong>key</strong></p>
<p>缓存的key,需要按照SpEL表达式编写，如果不指定则按照方法所有参数进行组合；</p>
<p>如@Cacheable(value=”testcache”,key=”#userName”)</p>
</li>
<li><p><strong>keyGenerator</strong></p>
<p>key的生成器；可以自己指定key的生成器的组件id</p>
<p>注意：key/keyGenerator：二选一使用;</p>
</li>
<li><p><strong>condition</strong></p>
<p>缓存条件，使用SpEL编写，在调用方法之前之后都能判断；</p>
<p>如@Cacheable(value=”testcache”,condition=”#userName.length()&gt;2”)</p>
</li>
<li><p><strong>unless</strong>（@CachePut、@Cacheable）</p>
<p>用于否决缓存的条件，只在方法执行之后判断；</p>
<p>如@Cacheable(value=”testcache”,unless=”#result ==null”)</p>
</li>
<li><p><strong>beforeInvocation</strong>（@CacheEvict）</p>
<p>是否在执行前清空缓存，默认为false，false情况下方法执行异常则不会清空；</p>
<p>如@CachEvict(value=”testcache”，beforeInvocation=true)</p>
</li>
<li><p><strong>allEntries</strong>（@CacheEvict）</p>
<p>是否清空所有缓存内容，默认为false；</p>
<p>如@CachEvict(value=”testcache”,allEntries=true)</p>
</li>
</ul>
<h3 id="2-缓存可用的SpEL表达式"><a href="#2-缓存可用的SpEL表达式" class="headerlink" title="2 . 缓存可用的SpEL表达式"></a>2 . 缓存可用的SpEL表达式</h3><p><strong>root</strong></p>
<p>表示根对象，不可省略</p>
<ul>
<li><p>被调用方法名 <strong>methodName</strong></p>
<p>如 #root.methodName</p>
</li>
<li><p>被调用方法 <strong>method</strong></p>
<p>如 #root.method.name</p>
</li>
<li><p>目标对象 <strong>target</strong></p>
<p>如 #root.target</p>
</li>
<li><p>被调用的目标对象类 <strong>targetClass</strong></p>
<p>如 #root.targetClass</p>
</li>
<li><p>被调用的方法的参数列表 <strong>args</strong></p>
<p>如 #root.args[0]</p>
</li>
<li><p>方法调用使用的缓存列表 <strong>caches</strong></p>
<p>如 #root.caches[0].name</p>
</li>
</ul>
<p><strong>参数名</strong></p>
<p>方法参数的名字. 可以直接 #参数名 ，也可以使用 #p0或#a0 的形式，0代表参数的索引；</p>
<p>如 #iban 、 #a0 、 #p0</p>
<p><strong>返回值</strong></p>
<p>方法执行后的返回值（仅当方法执行之后的判断有效，如‘unless’ ， @CachePut、@CacheEvict’的表达式beforeInvocation=false ）</p>
<p>如 #result</p>
<h2 id="四、-缓存使用"><a href="#四、-缓存使用" class="headerlink" title="四、 缓存使用"></a>四、 缓存使用</h2><h3 id="1-基本使用步骤"><a href="#1-基本使用步骤" class="headerlink" title="1. 基本使用步骤"></a>1. 基本使用步骤</h3><ol>
<li>引入spring-boot-starter-cache模块</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-cache&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>@EnableCaching开启缓存</p>
<p>在主配置类上标注</p>
</li>
<li><p>使用缓存注解</p>
<p>如@Cacheable、@CachePut</p>
</li>
<li><p>切换为其他缓存</p>
</li>
</ol>
<h3 id="2-搭建实验环境"><a href="#2-搭建实验环境" class="headerlink" title="2. 搭建实验环境"></a>2. 搭建实验环境</h3><ol>
<li><p>导入数据库文件 创建出department和employee表</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-- ----------------------------</span><br><span class="line">-- Table structure for department</span><br><span class="line">-- ----------------------------</span><br><span class="line">DROP TABLE IF EXISTS &#96;department&#96;;</span><br><span class="line">CREATE TABLE &#96;department&#96; (</span><br><span class="line">  &#96;id&#96; int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  &#96;departmentName&#96; varchar(255) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br><span class="line"></span><br><span class="line">-- ----------------------------</span><br><span class="line">-- Table structure for employee</span><br><span class="line">-- ----------------------------</span><br><span class="line">DROP TABLE IF EXISTS &#96;employee&#96;;</span><br><span class="line">CREATE TABLE &#96;employee&#96; (</span><br><span class="line">  &#96;id&#96; int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  &#96;lastName&#96; varchar(255) DEFAULT NULL,</span><br><span class="line">  &#96;email&#96; varchar(255) DEFAULT NULL,</span><br><span class="line">  &#96;gender&#96; int(2) DEFAULT NULL,</span><br><span class="line">  &#96;d_id&#96; int(11) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建javaBean封装数据</p>
</li>
<li><p>整合MyBatis操作数据库</p>
<p>配置数据源信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">spring.datasource.username&#x3D;root</span><br><span class="line">spring.datasource.password&#x3D;123</span><br><span class="line">spring.datasource.url&#x3D;jdbc:mysql:&#x2F;&#x2F;localhost:3306&#x2F;springboot?serverTimezone&#x3D;GMT</span><br><span class="line">spring.datasource.driver-class-name&#x3D;com.mysql.cj.jdbc.Driver</span><br><span class="line"></span><br><span class="line"># 开启驼峰命名法(否则部分字段封装不了)</span><br><span class="line">mybatis.configuration.map-underscore-to-camel-case&#x3D;true</span><br><span class="line">#打印sql</span><br><span class="line">logging.level.cn.edu.ustc.springboot.mapper&#x3D;debug</span><br><span class="line"></span><br><span class="line">debug&#x3D;true</span><br></pre></td></tr></table></figure>

<p>使用注解版的MyBatis；</p>
<p> @MapperScan指定需要扫描的mapper接口所在的包</p>
</li>
<li><p>主配置类开启@EnableCaching</p>
</li>
</ol>
<h3 id="3-快速体验缓存"><a href="#3-快速体验缓存" class="headerlink" title="3. 快速体验缓存"></a>3. 快速体验缓存</h3><p><strong>@Cacheable、@CachePut、@CacheEvict的使用</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class EmployeeService &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    private EmployeeMapper employeeMapper;</span><br><span class="line"></span><br><span class="line">    @Cacheable(value&#x3D;&#123;&quot;emp&quot;&#125;,</span><br><span class="line">            key &#x3D; &quot;#id+#root.methodName+#root.caches[0].name&quot;,</span><br><span class="line">            condition &#x3D; &quot;#a0&gt;1&quot;,</span><br><span class="line">            unless &#x3D; &quot;#p0&#x3D;&#x3D;2&quot;</span><br><span class="line">    )</span><br><span class="line">    public Employee getEmpById(Integer id) &#123;</span><br><span class="line">        System.out.println(&quot;查询员工：&quot;+id);</span><br><span class="line">        return employeeMapper.getEmpById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @CachePut(value &#x3D; &#123;&quot;emp&quot;&#125;,key &#x3D; &quot;#employee.id&quot; )</span><br><span class="line">    public Employee updateEmp(Employee employee) &#123;</span><br><span class="line">        System.out.println(&quot;更新员工&quot;+employee);</span><br><span class="line">        employeeMapper.updateEmp(employee);</span><br><span class="line">        return employee;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @CacheEvict(value &#x3D; &#123;&quot;emp&quot;&#125;,allEntries &#x3D; true,beforeInvocation &#x3D; true)</span><br><span class="line">    public Integer delEmp(Integer id)&#123;</span><br><span class="line">        int i&#x3D;1&#x2F;0;</span><br><span class="line">        System.out.println(&quot;删除员工：&quot;+id);</span><br><span class="line">        employeeMapper.delEmp(id);</span><br><span class="line">        return id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>自定义KeyGenerator</strong></p>
<p>使用时在注解属性内指定KeyGenerator=“myKeyGenerator”</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class MyCacheConfig &#123;</span><br><span class="line">    @Bean(&quot;myKeyGenerator&quot;)</span><br><span class="line">    public KeyGenerator myKeyGenerator() &#123;</span><br><span class="line">        return new KeyGenerator()&#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Object generate(Object target, Method method, Object... params) &#123;</span><br><span class="line">                return method.getName()+&quot;[&quot;+ Arrays.asList(params).toString()+target+&quot;]&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>@CacheConfig</strong></p>
<p>标注在类上，用于抽取@Cacheable的公共属性</p>
<p>由于一个类中可能会使用多次@Cacheable等注解，所以各项属性可以抽取到@CacheConfig</p>
<p><strong>@Caching</strong></p>
<p>组合使用@Cacheable、@CachePut、@CacheEvict</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Caching(</span><br><span class="line">       cacheable &#x3D; &#123;</span><br><span class="line">           @Cacheable(&#x2F;*value&#x3D;&quot;emp&quot;,*&#x2F;key &#x3D; &quot;#lastName&quot;)</span><br><span class="line">       &#125;,</span><br><span class="line">       put &#x3D; &#123;</span><br><span class="line">           @CachePut(&#x2F;*value&#x3D;&quot;emp&quot;,*&#x2F;key &#x3D; &quot;#result.id&quot;),</span><br><span class="line">           @CachePut(&#x2F;*value&#x3D;&quot;emp&quot;,*&#x2F;key &#x3D; &quot;#result.email&quot;)</span><br><span class="line">       &#125;</span><br><span class="line">  )</span><br><span class="line">  public Employee getEmpByLastName(String lastName)&#123;</span><br><span class="line">      return employeeMapper.getEmpByLastName(lastName);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-工作原理"><a href="#4-工作原理" class="headerlink" title="4. 工作原理"></a>4. 工作原理</h3><p>缓存的自动配置类CacheAutoConfiguration向容器中导入了CacheConfigurationImportSelector，此类的selectImports()方法添加了许多配置类，其中SimpleCacheConfiguration默认生效</p>
<p> GenericCacheConfiguration<br>​ JCacheCacheConfiguration<br>​ EhCacheCacheConfiguration<br>​ HazelcastCacheConfiguration<br>​ InfinispanCacheConfiguration<br>​ CouchbaseCacheConfiguration<br>​ RedisCacheConfiguration<br>​ CaffeineCacheConfiguration<br>​ GuavaCacheConfiguration<br>​ SimpleCacheConfiguration【默认】<br>​ NoOpCacheConfiguration</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Import(&#123; CacheConfigurationImportSelector.class, CacheManagerEntityManagerFactoryDependsOnPostProcessor.class &#125;)</span><br><span class="line">public class CacheAutoConfiguration &#123;</span><br><span class="line">    static class CacheConfigurationImportSelector implements ImportSelector &#123;</span><br><span class="line"></span><br><span class="line">		@Override</span><br><span class="line">		public String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">			CacheType[] types &#x3D; CacheType.values();</span><br><span class="line">			String[] imports &#x3D; new String[types.length];</span><br><span class="line">			for (int i &#x3D; 0; i &lt; types.length; i++) &#123;</span><br><span class="line">                &#x2F;&#x2F;将即将导入的各配置类存入字符数组内</span><br><span class="line">				imports[i] &#x3D; CacheConfigurations.getConfigurationClass(types[i]);</span><br><span class="line">			&#125;</span><br><span class="line">			return imports;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SimpleCacheConfiguration向容器中导入了ConcurrentMapCacheManager</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Configuration(proxyBeanMethods &#x3D; false)</span><br><span class="line">@ConditionalOnMissingBean(CacheManager.class)</span><br><span class="line">@Conditional(CacheCondition.class)</span><br><span class="line">class SimpleCacheConfiguration &#123;</span><br><span class="line">    &#x2F;&#x2F;向容器中导入ConcurrentMapCacheManager</span><br><span class="line">	@Bean</span><br><span class="line">	ConcurrentMapCacheManager cacheManager(CacheProperties cacheProperties,</span><br><span class="line">			CacheManagerCustomizers cacheManagerCustomizers) &#123;</span><br><span class="line">		ConcurrentMapCacheManager cacheManager &#x3D; new ConcurrentMapCacheManager();</span><br><span class="line">		List&lt;String&gt; cacheNames &#x3D; cacheProperties.getCacheNames();</span><br><span class="line">		if (!cacheNames.isEmpty()) &#123;</span><br><span class="line">			cacheManager.setCacheNames(cacheNames);</span><br><span class="line">		&#125;</span><br><span class="line">		return cacheManagerCustomizers.customize(cacheManager);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ConcurrentMapCacheManager使用ConcurrentMap以k-v的方式存储缓存缓存，下面以@Cacheable的运行流程为例说明ConcurrentMapCacheManager的作用。</p>
<p><strong>==@Cacheable的运行流程==</strong></p>
<ol>
<li><p>方法运行之前，先去查询Cache（缓存组件），<strong>按照cacheNames指定的名字获取</strong>；<br>（CacheManager先获取相应的缓存），第一次获取缓存如果没有Cache组件会自动创建,并以cacheNames-cache对放入ConcurrentMap。</p>
</li>
<li><p>去Cache中查找缓存的内容，使用一个key，默认就是方法的参数；<br><strong>key是按照某种策略生成的</strong>；默认是使用keyGenerator生成的，默认使用SimpleKeyGenerator生成key；</p>
<p> SimpleKeyGenerator生成key的默认策略；</p>
<p> 如果没有参数；key=new SimpleKey()；<br>​ 如果有一个参数：key=参数的值<br>​ 如果有多个参数：key=new SimpleKey(params)；</p>
</li>
<li><p>没有查到缓存就调用目标方法；</p>
</li>
<li><p>将目标方法返回的结果，放进缓存中</p>
</li>
</ol>
<p>@Cacheable标注的方法执行之前先来检查缓存中有没有这个数据，默认按照参数的值作为key去查询缓存，<br>如果没有就运行方法并将结果放入缓存；以后再来调用就可以直接使用缓存中的数据；</p>
<p>核心：<br>1）、使用CacheManager【ConcurrentMapCacheManager】按照名字得到Cache【ConcurrentMapCache】组件<br>2）、key使用keyGenerator生成的，默认是SimpleKeyGenerator</p>
<p><strong>源码分析</strong></p>
<p>默认使用ConcurrentMapCacheManager管理缓存，该类使用ConcurrentMap保存缓存，获取缓存如果没有Cache组件会自动创建,并以cacheNames-cache对放入ConcurrentMap。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class ConcurrentMapCacheManager implements CacheManager, BeanClassLoaderAware &#123;</span><br><span class="line"></span><br><span class="line">	private final ConcurrentMap&lt;String, Cache&gt; cacheMap &#x3D; new ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">	private boolean dynamic &#x3D; true;</span><br><span class="line">    </span><br><span class="line">   &#x2F;&#x2F;获取缓存</span><br><span class="line">	public Cache getCache(String name) &#123;</span><br><span class="line">		Cache cache &#x3D; this.cacheMap.get(name);</span><br><span class="line">        &#x2F;&#x2F;如果没有缓存会自动创建</span><br><span class="line">		if (cache &#x3D;&#x3D; null &amp;&amp; this.dynamic) &#123;</span><br><span class="line">			synchronized (this.cacheMap) &#123;</span><br><span class="line">				cache &#x3D; this.cacheMap.get(name);</span><br><span class="line">				if (cache &#x3D;&#x3D; null) &#123;</span><br><span class="line">					cache &#x3D; createConcurrentMapCache(name);</span><br><span class="line">					this.cacheMap.put(name, cache);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		return cache;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在@Cacheable标注方法执行前执行CacheAspectSupport的execute()方法，在该方法中会以一定的规则生成key，并尝试在缓存中通过该key获取值，若通过key获取到值则直接返回，不用执行@Cacheable标注方法，否则执行该方法获得返回值。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public abstract class CacheAspectSupport extends AbstractCacheInvoker</span><br><span class="line">		implements BeanFactoryAware, InitializingBean, SmartInitializingSingleton &#123;</span><br><span class="line">    &#x2F;&#x2F;在执行@Cacheable标注的方法前执行此方法</span><br><span class="line">    @Nullable</span><br><span class="line">	private Object execute(final CacheOperationInvoker invoker, Method method, CacheOperationContexts contexts) &#123;</span><br><span class="line">		if (contexts.isSynchronized()) &#123;</span><br><span class="line">			CacheOperationContext context &#x3D; contexts.get(CacheableOperation.class).iterator().next();</span><br><span class="line">			if (isConditionPassing(context, CacheOperationExpressionEvaluator.NO_RESULT)) &#123;</span><br><span class="line">				Object key &#x3D; generateKey(context, CacheOperationExpressionEvaluator.NO_RESULT);</span><br><span class="line">				Cache cache &#x3D; context.getCaches().iterator().next();</span><br><span class="line">				try &#123;</span><br><span class="line">					return wrapCacheValue(method, cache.get(key, () -&gt; unwrapReturnValue(invokeOperation(invoker))));</span><br><span class="line">				&#125;</span><br><span class="line">				catch (Cache.ValueRetrievalException ex) &#123;</span><br><span class="line">					throw (CacheOperationInvoker.ThrowableWrapper) ex.getCause();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">				return invokeOperation(invoker);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">        </span><br><span class="line">		processCacheEvicts(contexts.get(CacheEvictOperation.class), true,</span><br><span class="line">				CacheOperationExpressionEvaluator.NO_RESULT);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 见findCachedItem方法</span><br><span class="line">        &#x2F;&#x2F;此方法通过一定规则生成的key找cache，若没找到则返回null</span><br><span class="line">		Cache.ValueWrapper cacheHit &#x3D; findCachedItem(contexts.get(CacheableOperation.class));</span><br><span class="line"></span><br><span class="line">		List&lt;CachePutRequest&gt; cachePutRequests &#x3D; new LinkedList&lt;&gt;();</span><br><span class="line">		if (cacheHit &#x3D;&#x3D; null) &#123;</span><br><span class="line">			collectPutRequests(contexts.get(CacheableOperation.class),</span><br><span class="line">					CacheOperationExpressionEvaluator.NO_RESULT, cachePutRequests);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Object cacheValue;</span><br><span class="line">		Object returnValue;</span><br><span class="line"></span><br><span class="line">		if (cacheHit !&#x3D; null &amp;&amp; !hasCachePut(contexts)) &#123;</span><br><span class="line">			&#x2F;&#x2F; 如果通过该key找到缓存，且无@cacheput,则直接返回cacheValue</span><br><span class="line">			cacheValue &#x3D; cacheHit.get();</span><br><span class="line">			returnValue &#x3D; wrapCacheValue(method, cacheValue);</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			&#x2F;&#x2F; 若通过该key未找到缓存，则执行@cacheable标注方法</span><br><span class="line">			returnValue &#x3D; invokeOperation(invoker);</span><br><span class="line">			cacheValue &#x3D; unwrapReturnValue(returnValue);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		&#x2F;&#x2F; Collect any explicit @CachePuts</span><br><span class="line">		collectPutRequests(contexts.get(CachePutOperation.class), cacheValue, cachePutRequests);</span><br><span class="line"></span><br><span class="line">		&#x2F;&#x2F; Process any collected put requests, either from @CachePut or a @Cacheable miss</span><br><span class="line">		for (CachePutRequest cachePutRequest : cachePutRequests) &#123;</span><br><span class="line">			cachePutRequest.apply(cacheValue);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		&#x2F;&#x2F; Process any late evictions</span><br><span class="line">		processCacheEvicts(contexts.get(CacheEvictOperation.class), false, cacheValue);</span><br><span class="line"></span><br><span class="line">		return returnValue;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    @Nullable</span><br><span class="line">	private Cache.ValueWrapper findCachedItem(Collection&lt;CacheOperationContext&gt; contexts) &#123;</span><br><span class="line">		Object result &#x3D; CacheOperationExpressionEvaluator.NO_RESULT;</span><br><span class="line">		for (CacheOperationContext context : contexts) &#123;</span><br><span class="line">			if (isConditionPassing(context, result)) &#123;</span><br><span class="line">                &#x2F;&#x2F;通过一定规则生成key值(生成规则见generateKey方法)</span><br><span class="line">				Object key &#x3D; generateKey(context, result);</span><br><span class="line">                &#x2F;&#x2F;通过生成的key寻找缓存</span><br><span class="line">				Cache.ValueWrapper cached &#x3D; findInCaches(context, key);</span><br><span class="line">				if (cached !&#x3D; null) &#123;</span><br><span class="line">					return cached;</span><br><span class="line">				&#125;</span><br><span class="line">				else &#123;</span><br><span class="line">					if (logger.isTraceEnabled()) &#123;</span><br><span class="line">						logger.trace(&quot;No cache entry for key &#39;&quot; + key + &quot;&#39; in cache(s) &quot; + context.getCacheNames());</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		return null;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;key的生成策略</span><br><span class="line">    @Nullable</span><br><span class="line">    protected Object generateKey(@Nullable Object result) &#123;</span><br><span class="line">        &#x2F;&#x2F;如果@Cacheable设置了属性key，则根据设置值生成key</span><br><span class="line">        if (StringUtils.hasText(this.metadata.operation.getKey())) &#123;</span><br><span class="line">            EvaluationContext evaluationContext &#x3D; createEvaluationContext(result);</span><br><span class="line">            return evaluator.key(this.metadata.operation.getKey(), this.metadata.methodKey, evaluationContext);</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;否则使用keyGenerator生成key，默认keyGenerator为SimpleKeyGenerator</span><br><span class="line">        return this.metadata.keyGenerator.generate(this.target, this.metadata.method, this.args);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>默认情况下使用SimpleKeyGenerator生成key</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class SimpleKeyGenerator implements KeyGenerator &#123;</span><br><span class="line">    &#x2F;&#x2F;SimpleKeyGenerator的生成规则</span><br><span class="line">    public static Object generateKey(Object... params) &#123;</span><br><span class="line">        &#x2F;&#x2F;若无参，则返回空key</span><br><span class="line">		if (params.length &#x3D;&#x3D; 0) &#123;</span><br><span class="line">			return SimpleKey.EMPTY;</span><br><span class="line">		&#125;</span><br><span class="line">		if (params.length &#x3D;&#x3D; 1) &#123;</span><br><span class="line">			Object param &#x3D; params[0];</span><br><span class="line">			if (param !&#x3D; null &amp;&amp; !param.getClass().isArray()) &#123;</span><br><span class="line">                &#x2F;&#x2F;1个参数，则直接返回该参数</span><br><span class="line">				return param;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">          &#x2F;&#x2F;多个参数返回数组</span><br><span class="line">		return new SimpleKey(params);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认的缓存类ConcurrentMapCache，使用ConcurrentMap存储k-v</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class ConcurrentMapCache extends AbstractValueAdaptingCache &#123;</span><br><span class="line"></span><br><span class="line">	private final String name;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;存储key-cacheValue</span><br><span class="line">	private final ConcurrentMap&lt;Object, Object&gt; store;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;通过key查找cacheValue</span><br><span class="line">	protected Object lookup(Object key) &#123;</span><br><span class="line">		return this.store.get(key);</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;方法调用完后将结果存入缓存中</span><br><span class="line">    public void put(Object key, @Nullable Object value) &#123;</span><br><span class="line">		this.store.put(key, toStoreValue(value));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="五、Redis与缓存"><a href="#五、Redis与缓存" class="headerlink" title="五、Redis与缓存"></a>五、Redis与缓存</h2><h3 id="1-环境搭建"><a href="#1-环境搭建" class="headerlink" title="1. 环境搭建"></a>1. 环境搭建</h3><p>导入依赖</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">     &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">     &lt;artifactId&gt;spring-boot-starter-data-redis&lt;&#x2F;artifactId&gt;</span><br><span class="line"> &lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<p>在spring.properties指定Redis服务器地址</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#redis服务器主机地址</span><br><span class="line">spring.redis.host&#x3D;192.168.31.162</span><br></pre></td></tr></table></figure>

<h3 id="2-RedisTemplate"><a href="#2-RedisTemplate" class="headerlink" title="2. RedisTemplate"></a>2. RedisTemplate</h3><p>RedisAutoConfiguration向容器中导入了两个类RedisTemplate&lt;Object, Object&gt; redisTemplate和StringRedisTemplate，作为Redis客户端分别操作k-v都为对象和k-v都为字符串的值</p>
<p><strong>Redis常见的五大数据类型</strong></p>
<p>String（字符串）、List（列表）、Set（集合）、Hash（散列）、ZSet（有序集合）</p>
<p> stringRedisTemplate.opsForValue()[String（字符串）]</p>
<p> stringRedisTemplate.opsForList()[List（列表）]</p>
<p> stringRedisTemplate.opsForSet()[Set（集合）]</p>
<p> stringRedisTemplate.opsForHash()[Hash（散列）]</p>
<p> stringRedisTemplate.opsForZSet()[ZSet（有序集合）]</p>
<h3 id="3-Redis缓存使用"><a href="#3-Redis缓存使用" class="headerlink" title="3. Redis缓存使用"></a>3. Redis缓存使用</h3><p>在导入redis依赖后RedisCacheConfiguration类就会自动生效，创建RedisCacheManager，并使用RedisCache进行缓存数据，要缓存的对象的类要实现Serializable接口，默认情况下是以<strong>jdk序列化数据</strong>存在redis中，如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">k:&quot;emp::1&quot;</span><br><span class="line">v:</span><br><span class="line">\xAC\xED\x00\x05sr\x00$cn.edu.ustc.springboot.bean.Employeeuqf\x03p\x9A\xCF\xE0\x02\x00\x05L\x00\x03dIdt\x00\x13Ljava&#x2F;lang&#x2F;Integer;L\x00\x05emailt\x00\x12Ljava&#x2F;lang&#x2F;String;L\x00\x06genderq\x00~\x00\x01L\x00\x02idq\x00~\x00\x01L\x00\x08lastNameq\x00~\x00\x02xpsr\x00\x11java.lang.Integer\x12\xE2\xA0\xA4\xF7\x81\x878\x02\x00\x01I\x00\x05valuexr\x00\x10java.lang.Number\x86\xAC\x95\x1D\x0B\x94\xE0\x8B\x02\x00\x00xp\x00\x00\x00\x03t\x00\x07cch@aaasq\x00~\x00\x04\x00\x00\x00\x01q\x00~\x00\x08t\x00\x03cch</span><br></pre></td></tr></table></figure>

<p>要想让对象以<strong>json形式</strong>存储在redis中，需要自定义RedisCacheManager，使用GenericJackson2JsonRedisSerializer类对value进行序列化</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class MyRedisConfig &#123;</span><br><span class="line">    @Bean</span><br><span class="line">    RedisCacheManager cacheManager(RedisConnectionFactory factory)&#123;</span><br><span class="line">        &#x2F;&#x2F;创建默认RedisCacheWriter</span><br><span class="line">        RedisCacheWriter cacheWriter &#x3D; RedisCacheWriter.nonLockingRedisCacheWriter(factory);</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F;创建默认RedisCacheConfiguration并使用GenericJackson2JsonRedisSerializer构造的		SerializationPair对value进行转换</span><br><span class="line">        &#x2F;&#x2F;创建GenericJackson2JsonRedisSerializer的json序列化器</span><br><span class="line">        GenericJackson2JsonRedisSerializer jsonRedisSerializer &#x3D; new GenericJackson2JsonRedisSerializer();</span><br><span class="line">        &#x2F;&#x2F;使用json序列化器构造出对转换Object类型的SerializationPair序列化对</span><br><span class="line">        RedisSerializationContext.SerializationPair&lt;Object&gt; serializationPair &#x3D; RedisSerializationContext.SerializationPair.fromSerializer(jsonRedisSerializer);</span><br><span class="line">        &#x2F;&#x2F;将可以把Object转换为json的SerializationPair传入RedisCacheConfiguration</span><br><span class="line">        &#x2F;&#x2F;使得RedisCacheConfiguration在转换value时使用定制序列化器</span><br><span class="line">        RedisCacheConfiguration cacheConfiguration&#x3D;RedisCacheConfiguration.defaultCacheConfig().serializeValuesWith(serializationPair);</span><br><span class="line">        </span><br><span class="line">        RedisCacheManager cacheManager &#x3D; new RedisCacheManager(cacheWriter,cacheConfiguration);</span><br><span class="line">        return cacheManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>序列化数据如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">k:&quot;emp::3&quot;</span><br><span class="line"></span><br><span class="line">v:</span><br><span class="line">&#123;</span><br><span class="line">  &quot;@class&quot;: &quot;cn.edu.ustc.springboot.bean.Employee&quot;,</span><br><span class="line">  &quot;id&quot;: 3,</span><br><span class="line">  &quot;lastName&quot;: &quot;aaa&quot;,</span><br><span class="line">  &quot;email&quot;: &quot;aaaa&quot;,</span><br><span class="line">  &quot;gender&quot;: 1,</span><br><span class="line">  &quot;dId&quot;: 5</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>，这里必须用<strong>GenericJackson2JsonRedisSerializer</strong>进行value的序列化解析，如果使用Jackson2JsonRedisSerializer，序列化的json没有<code>&quot;@class&quot;: &quot;cn.edu.ustc.springboot.bean.Employee&quot;</code>,在读取缓存时会报类型转换异常。</p>
<h3 id="4-Redis缓存原理"><a href="#4-Redis缓存原理" class="headerlink" title="4. Redis缓存原理"></a>4. Redis缓存原理</h3><p>配置类RedisCacheConfiguration向容器中导入了其定制的RedisCacheManager，在默认的RedisCacheManager的配置中，是使用jdk序列化value值</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Configuration(proxyBeanMethods &#x3D; false)</span><br><span class="line">@ConditionalOnClass(RedisConnectionFactory.class)</span><br><span class="line">@AutoConfigureAfter(RedisAutoConfiguration.class)</span><br><span class="line">@ConditionalOnBean(RedisConnectionFactory.class)</span><br><span class="line">@ConditionalOnMissingBean(CacheManager.class)</span><br><span class="line">@Conditional(CacheCondition.class)</span><br><span class="line">class RedisCacheConfiguration &#123;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;向容器中导入RedisCacheManager</span><br><span class="line">	@Bean</span><br><span class="line">	RedisCacheManager cacheManager(CacheProperties cacheProperties, CacheManagerCustomizers cacheManagerCustomizers,</span><br><span class="line">			ObjectProvider&lt;org.springframework.data.redis.cache.RedisCacheConfiguration&gt; redisCacheConfiguration,</span><br><span class="line">			ObjectProvider&lt;RedisCacheManagerBuilderCustomizer&gt; redisCacheManagerBuilderCustomizers,</span><br><span class="line">			RedisConnectionFactory redisConnectionFactory, ResourceLoader resourceLoader) &#123;</span><br><span class="line">		&#x2F;&#x2F;使用determineConfiguration()的返回值生成RedisCacheManagerBuilder</span><br><span class="line">        &#x2F;&#x2F;调用了RedisCacheManagerBuilder的cacheDefaults()方法(见下一代码块)</span><br><span class="line">        RedisCacheManagerBuilder builder &#x3D; RedisCacheManager.builder(redisConnectionFactory).cacheDefaults(</span><br><span class="line">				determineConfiguration(cacheProperties, redisCacheConfiguration, resourceLoader.getClassLoader()));</span><br><span class="line">		List&lt;String&gt; cacheNames &#x3D; cacheProperties.getCacheNames();</span><br><span class="line">		if (!cacheNames.isEmpty()) &#123;</span><br><span class="line">			builder.initialCacheNames(new LinkedHashSet&lt;&gt;(cacheNames));</span><br><span class="line">		&#125;</span><br><span class="line">		redisCacheManagerBuilderCustomizers.orderedStream().forEach((customizer) -&gt; customizer.customize(builder));</span><br><span class="line">        &#x2F;&#x2F;使用RedisCacheManagerBuilder的build()方法创建RedisCacheManager并进行定制操作</span><br><span class="line">		return cacheManagerCustomizers.customize(builder.build());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">	private org.springframework.data.redis.cache.RedisCacheConfiguration determineConfiguration(</span><br><span class="line">			CacheProperties cacheProperties,</span><br><span class="line">			ObjectProvider&lt;org.springframework.data.redis.cache.RedisCacheConfiguration&gt; redisCacheConfiguration,</span><br><span class="line">			ClassLoader classLoader) &#123;</span><br><span class="line">        &#x2F;&#x2F;determineConfiguration()调用了createConfiguration()</span><br><span class="line">		return redisCacheConfiguration.getIfAvailable(() -&gt; createConfiguration(cacheProperties, classLoader));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;createConfiguration()定义了其序列化value的规则</span><br><span class="line">	private org.springframework.data.redis.cache.RedisCacheConfiguration createConfiguration(</span><br><span class="line">			CacheProperties cacheProperties, ClassLoader classLoader) &#123;</span><br><span class="line">		Redis redisProperties &#x3D; cacheProperties.getRedis();</span><br><span class="line">		org.springframework.data.redis.cache.RedisCacheConfiguration config &#x3D; org.springframework.data.redis.cache.RedisCacheConfiguration</span><br><span class="line">				.defaultCacheConfig();</span><br><span class="line">        &#x2F;&#x2F;使用jdk序列化器对value进行序列化</span><br><span class="line">		config &#x3D; config.serializeValuesWith(</span><br><span class="line">				SerializationPair.fromSerializer(new JdkSerializationRedisSerializer(classLoader)));</span><br><span class="line">        &#x2F;&#x2F;设置properties文件中设置的各项属性</span><br><span class="line">		if (redisProperties.getTimeToLive() !&#x3D; null) &#123;</span><br><span class="line">			config &#x3D; config.entryTtl(redisProperties.getTimeToLive());</span><br><span class="line">		&#125;</span><br><span class="line">		if (redisProperties.getKeyPrefix() !&#x3D; null) &#123;</span><br><span class="line">			config &#x3D; config.prefixKeysWith(redisProperties.getKeyPrefix());</span><br><span class="line">		&#125;</span><br><span class="line">		if (!redisProperties.isCacheNullValues()) &#123;</span><br><span class="line">			config &#x3D; config.disableCachingNullValues();</span><br><span class="line">		&#125;</span><br><span class="line">		if (!redisProperties.isUseKeyPrefix()) &#123;</span><br><span class="line">			config &#x3D; config.disableKeyPrefix();</span><br><span class="line">		&#125;</span><br><span class="line">		return config;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RedisCacheManager的直接构造类，该类保存了配置类RedisCacheConfiguration，该配置在会传递给RedisCacheManager</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public static class RedisCacheManagerBuilder &#123;</span><br><span class="line"></span><br><span class="line">		private final RedisCacheWriter cacheWriter;</span><br><span class="line">    	&#x2F;&#x2F;默认缓存配置使用RedisCacheConfiguration的默认配置</span><br><span class="line">    	&#x2F;&#x2F;该默认配置缓存时默认将k按字符串存储，v按jdk序列化数据存储(见下一代码块)</span><br><span class="line">		private RedisCacheConfiguration defaultCacheConfiguration &#x3D; RedisCacheConfiguration.defaultCacheConfig();</span><br><span class="line">		private final Map&lt;String, RedisCacheConfiguration&gt; initialCaches &#x3D; new LinkedHashMap&lt;&gt;();</span><br><span class="line">		private boolean enableTransactions;</span><br><span class="line">		boolean allowInFlightCacheCreation &#x3D; true;</span><br><span class="line"></span><br><span class="line">		private RedisCacheManagerBuilder(RedisCacheWriter cacheWriter) &#123;</span><br><span class="line">			this.cacheWriter &#x3D; cacheWriter;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">    	&#x2F;&#x2F;传入RedisCacheManagerBuilder使用的缓存配置规则RedisCacheConfiguration类</span><br><span class="line">		public RedisCacheManagerBuilder cacheDefaults(RedisCacheConfiguration defaultCacheConfiguration) &#123;</span><br><span class="line"></span><br><span class="line">			Assert.notNull(defaultCacheConfiguration, &quot;DefaultCacheConfiguration must not be null!&quot;);</span><br><span class="line"></span><br><span class="line">			this.defaultCacheConfiguration &#x3D; defaultCacheConfiguration;</span><br><span class="line"></span><br><span class="line">			return this;</span><br><span class="line">		&#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;使用默认defaultCacheConfiguration创建RedisCacheManager</span><br><span class="line">    public RedisCacheManager build() &#123;</span><br><span class="line"></span><br><span class="line">			RedisCacheManager cm &#x3D; new RedisCacheManager(cacheWriter, defaultCacheConfiguration, initialCaches,</span><br><span class="line">					allowInFlightCacheCreation);</span><br><span class="line"></span><br><span class="line">			cm.setTransactionAware(enableTransactions);</span><br><span class="line"></span><br><span class="line">			return cm;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>RedisCacheConfiguration保存了许多缓存规则，这些规则都保存在RedisCacheManagerBuilder的RedisCacheConfiguration defaultCacheConfiguration属性中，并且当RedisCacheManagerBuilder创建RedisCacheManager传递过去</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class RedisCacheConfiguration &#123;</span><br><span class="line"></span><br><span class="line">	private final Duration ttl;</span><br><span class="line">	private final boolean cacheNullValues;</span><br><span class="line">	private final CacheKeyPrefix keyPrefix;</span><br><span class="line">	private final boolean usePrefix;</span><br><span class="line"></span><br><span class="line">	private final SerializationPair&lt;String&gt; keySerializationPair;</span><br><span class="line">	private final SerializationPair&lt;Object&gt; valueSerializationPair;</span><br><span class="line"></span><br><span class="line">	private final ConversionService conversionService;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;默认缓存配置</span><br><span class="line">    public static RedisCacheConfiguration defaultCacheConfig(@Nullable ClassLoader classLoader) &#123;</span><br><span class="line"></span><br><span class="line">            DefaultFormattingConversionService conversionService &#x3D; new DefaultFormattingConversionService();</span><br><span class="line"></span><br><span class="line">            registerDefaultConverters(conversionService);</span><br><span class="line"></span><br><span class="line">            return new RedisCacheConfiguration(Duration.ZERO, true, true, CacheKeyPrefix.simple(),</span><br><span class="line">                                     SerializationPair.fromSerializer(RedisSerializer.string()),&#x2F;&#x2F;key使用字符串</span><br><span class="line">                                               SerializationPair.fromSerializer(RedisSerializer.java(classLoader)), conversionService);</span><br><span class="line">        &#x2F;&#x2F;value按jdk序列化存储</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>RedisCacheManager在创建RedisCache时将RedisCacheConfiguration传递过去，并在创建RedisCache时通过createRedisCache()起作用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class RedisCacheManager extends AbstractTransactionSupportingCacheManager &#123;</span><br><span class="line"></span><br><span class="line">	private final RedisCacheWriter cacheWriter;</span><br><span class="line">	private final RedisCacheConfiguration defaultCacheConfig;</span><br><span class="line">	private final Map&lt;String, RedisCacheConfiguration&gt; initialCacheConfiguration;</span><br><span class="line">	private final boolean allowInFlightCacheCreation;</span><br><span class="line">    </span><br><span class="line">    	protected RedisCache createRedisCache(String name, @Nullable RedisCacheConfiguration cacheConfig) &#123;</span><br><span class="line">        &#x2F;&#x2F;如果调用该方法时RedisCacheConfiguration有值则使用定制的，否则则使用默认的RedisCacheConfiguration defaultCacheConfig，即RedisCacheManagerBuilder传递过来的配置</span><br><span class="line">		return new RedisCache(name, cacheWriter, cacheConfig !&#x3D; null ? cacheConfig : defaultCacheConfig);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>RedisCache，Redis缓存，具体负责将缓存数据序列化的地方，将RedisCacheConfiguration的序列化对SerializationPair提取出来并使用其定义的序列化方式分别对k和v进行序列化操作</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class RedisCache extends AbstractValueAdaptingCache &#123;</span><br><span class="line">    </span><br><span class="line">    private static final byte[] BINARY_NULL_VALUE &#x3D; RedisSerializer.java().serialize(NullValue.INSTANCE);</span><br><span class="line"></span><br><span class="line">	private final String name;</span><br><span class="line">	private final RedisCacheWriter cacheWriter;</span><br><span class="line">	private final RedisCacheConfiguration cacheConfig;</span><br><span class="line">	private final ConversionService conversionService;</span><br><span class="line">    </span><br><span class="line">    public void put(Object key, @Nullable Object value) &#123;</span><br><span class="line"></span><br><span class="line">		Object cacheValue &#x3D; preProcessCacheValue(value);</span><br><span class="line"></span><br><span class="line">		if (!isAllowNullValues() &amp;&amp; cacheValue &#x3D;&#x3D; null) &#123;</span><br><span class="line"></span><br><span class="line">			throw new IllegalArgumentException(String.format(</span><br><span class="line">					&quot;Cache &#39;%s&#39; does not allow &#39;null&#39; values. Avoid storing null via &#39;@Cacheable(unless&#x3D;\&quot;#result &#x3D;&#x3D; null\&quot;)&#39; or configure RedisCache to allow &#39;null&#39; via RedisCacheConfiguration.&quot;,</span><br><span class="line">					name));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;在put k-v时使用cacheConfig中的k-v序列化器分别对k-v进行序列化</span><br><span class="line">		cacheWriter.put(name, createAndConvertCacheKey(key), serializeCacheValue(cacheValue), cacheConfig.getTtl());</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;从cacheConfig(即RedisCacheConfiguration)中获取KeySerializationPair并写入key值</span><br><span class="line">    protected byte[] serializeCacheKey(String cacheKey) &#123;</span><br><span class="line">		return ByteUtils.getBytes(cacheConfig.getKeySerializationPair().write(cacheKey));</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;从cacheConfig(即RedisCacheConfiguration)中获取ValueSerializationPair并写入key值</span><br><span class="line">    protected byte[] serializeCacheValue(Object value) &#123;</span><br><span class="line"></span><br><span class="line">        if (isAllowNullValues() &amp;&amp; value instanceof NullValue) &#123;</span><br><span class="line">            return BINARY_NULL_VALUE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return ByteUtils.getBytes(cacheConfig.getValueSerializationPair().write(value));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>分析到这也就不难理解，要使用json保存序列化数据时，需要自定义RedisCacheManager，在RedisCacheConfiguration中定义序列化转化规则，并向RedisCacheManager传入我们自己定制的RedisCacheConfiguration了，我定制的序列化规则会跟随RedisCacheConfiguration一直传递到RedisCache，并在序列化时发挥作用。</p>
<h1 id="二-Spring-Boot与消息"><a href="#二-Spring-Boot与消息" class="headerlink" title="(二) Spring Boot与消息"></a>(二) Spring Boot与消息</h1><h2 id="一、消息简介"><a href="#一、消息简介" class="headerlink" title="一、消息简介"></a>一、消息简介</h2><p><strong>消息代理规范</strong></p>
<ul>
<li>JMS（Java Message Service）JAVA消息服务<ul>
<li>基于JVM消息代理的规范。ActiveMQ、HornetMQ是JMS实现</li>
</ul>
</li>
<li>AMQP（Advanced Message Queuing Protocol）<ul>
<li>高级消息队列协议，也是一个消息代理的规范，兼容JMS</li>
<li>RabbitMQ是AMQP的实现</li>
</ul>
</li>
</ul>
<p><strong>作用</strong></p>
<p>通过消息服务中间件来提升系统异步通信、扩展解耦能力</p>
<p>当消息发送者发送消息以后，将由消息代理接管，消息代理保证消息传递到指定目的地</p>
<p><strong>应用场景</strong></p>
<ol>
<li><p>异步处理</p>
<p>用户注册操作和消息处理并行，提高响应速度</p>
</li>
</ol>
<p><a href="https://niceseason.github.io/images/图片3.png" target="_blank" rel="noopener"><img src="https://niceseason.github.io/images/%E5%9B%BE%E7%89%873.png" alt="img"></a></p>
<ol>
<li><p>应用解耦</p>
<p>在下单时库存系统不能正常使用。也不影响正常下单，因为下单后，订单系统写入消息队列就不再关心其他的后续操作了。实现订单系统与库存系统的应用解耦</p>
<p><img src="https://niceseason.github.io/images/%E5%9B%BE%E7%89%874.png" alt="img"></p>
</li>
<li><p>流量削峰</p>
<p>用户的请求，服务器接收后，首先写入消息队列。假如消息队列长度超过最大数量，则直接抛弃用户请求或跳转到错误页面</p>
<p>秒杀业务根据消息队列中的请求信息，再做后续处理</p>
<p><a href="https://niceseason.github.io/images/图片5.png" target="_blank" rel="noopener"><img src="https://niceseason.github.io/images/%E5%9B%BE%E7%89%875.png" alt="img"></a></p>
</li>
</ol>
<h2 id="二、RabbitMQ"><a href="#二、RabbitMQ" class="headerlink" title="二、RabbitMQ"></a>二、RabbitMQ</h2><p>RabbitMQ是一个由erlang开发的AMQP(Advanved Message Queue Protocol)的开源实现。</p>
<h3 id="1-核心概念"><a href="#1-核心概念" class="headerlink" title="1. 核心概念"></a>1. 核心概念</h3><ul>
<li><strong>Message</strong><ul>
<li>消息，消息是不具名的，它由消息头和消息体组成</li>
<li>消息头，包括routing-key（路由键）、priority（相对于其他消息的优先权）、delivery-mode（指出该消息可能需要持久性存储）等</li>
</ul>
</li>
<li>Publisher<ul>
<li>消息的生产者，也是一个向交换器发布消息的客户端应用程序</li>
</ul>
</li>
<li><strong>Exchange</strong><ul>
<li>交换器，将生产者消息路由给服务器中的队列</li>
<li>类型有direct(默认)，fanout, topic, 和headers，具有不同转发策略</li>
</ul>
</li>
<li><strong>Queue</strong><ul>
<li>消息队列，保存消息直到发送给消费者</li>
</ul>
</li>
<li><strong>Binding</strong><ul>
<li>绑定，用于消息队列和交换器之间的关联</li>
</ul>
</li>
<li>Connection<ul>
<li>网络连接，比如一个TCP连接</li>
</ul>
</li>
<li>Consumer<ul>
<li>消息的消费者，表示一个从消息队列中取得消息的客户端应用程序</li>
</ul>
</li>
<li>Virtual Host<ul>
<li>虚拟主机，表示一批交换器、消息队列和相关对象。</li>
<li>vhost 是 AMQP 概念的基础，必须在连接时指定</li>
<li>RabbitMQ 默认的 vhost 是 /</li>
</ul>
</li>
<li>Broker<ul>
<li>消息队列服务器实体</li>
</ul>
</li>
</ul>
<h3 id="2-运行机制"><a href="#2-运行机制" class="headerlink" title="2. 运行机制"></a>2. 运行机制</h3><p><strong>消息路由</strong></p>
<p>AMQP 中增加了Exchange 和 Binding 的角色， Binding 决定交换器的消息应该发送到那个队列</p>
<p><strong>Exchange 类型</strong></p>
<ol>
<li><p>direct</p>
<p>点对点模式，消息中的路由键（routing key）如果和 Binding 中的 binding<br>key 一致， 交换器就将消息发到对应的队列中。</p>
</li>
<li><p>fanout</p>
<p>广播模式，每个发到 fanout 类型交换器的消息都会分到所有绑定的队列上去</p>
</li>
<li><p>topic</p>
<p>将路由键和某个模式进行匹配，此时队列需要绑定到一个模式上。它将路由键和绑定键的字符串切分成单词，这些单词之间用点隔开。<br>识别通配符： # 匹配 0 个或多个单词， *匹配一个单词</p>
<p><a href="https://niceseason.github.io/images/Snipaste_2020-04-09_14-11-13.png" target="_blank" rel="noopener"><img src="https://niceseason.github.io/images/Snipaste_2020-04-09_14-11-13.png" alt="img"></a></p>
</li>
</ol>
<h2 id="三、-Springboot中的RabbitMQ"><a href="#三、-Springboot中的RabbitMQ" class="headerlink" title="三、 Springboot中的RabbitMQ"></a>三、 Springboot中的RabbitMQ</h2><h3 id="1-环境准备"><a href="#1-环境准备" class="headerlink" title="1. 环境准备"></a>1. 环境准备</h3><p>在docker中安装rabbitmq并运行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 5672为服务端口，15672为web控制台端口</span><br><span class="line">docker run -d -p 5672:5672 -p 15672:15672 38e57f281891</span><br></pre></td></tr></table></figure>

<p>导入依赖</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">   &lt;dependency&gt;</span><br><span class="line">       &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">       &lt;artifactId&gt;spring-boot-starter-amqp&lt;&#x2F;artifactId&gt;</span><br><span class="line">   &lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;!--自定义消息转化器Jackson2JsonMessageConverter所需依赖--&gt;</span><br><span class="line">   &lt;dependency&gt;</span><br><span class="line">       &lt;groupId&gt;com.fasterxml.jackson.core&lt;&#x2F;groupId&gt;</span><br><span class="line">       &lt;artifactId&gt;jackson-databind&lt;&#x2F;artifactId&gt;</span><br><span class="line">   &lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<p>配置文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 指定rebbitmq服务器主机</span><br><span class="line">spring.rabbitmq.host&#x3D;192.168.31.162</span><br><span class="line">#spring.rabbitmq.username&#x3D;guest  默认值为guest</span><br><span class="line">#spring.rabbitmq.password&#x3D;guest	 默认值为guest</span><br></pre></td></tr></table></figure>

<h3 id="2-RabbitMQ的使用"><a href="#2-RabbitMQ的使用" class="headerlink" title="2. RabbitMQ的使用"></a>2. RabbitMQ的使用</h3><p>RabbitAutoConfiguration中有内部类RabbitTemplateConfiguration,在该类中向容器中分别导入了<strong>RabbitTemplate</strong>和<strong>AmqpAdmin</strong></p>
<p>在测试类中分别注入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Autowired</span><br><span class="line">   private RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">   @Autowired</span><br><span class="line">   private AmqpAdmin amqpAdmin;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>RabbitTemplate消息发送处理组件</strong></p>
<p> 可用来发送和接收消息</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;发送消息</span><br><span class="line">rabbitTemplate.convertAndSend(&quot;amq.direct&quot;,&quot;ustc&quot;,&quot;aaaa&quot;);</span><br><span class="line">      Book book &#x3D; new Book();</span><br><span class="line">      book.setName(&quot;西游记&quot;);</span><br><span class="line">      book.setPrice(23.2f);</span><br><span class="line">&#x2F;&#x2F;Book要实现Serializable接口</span><br><span class="line">      rabbitTemplate.convertAndSend(&quot;amq.direct&quot;,&quot;ustc&quot;,book);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;接收消息</span><br><span class="line">Object o &#x3D; rabbitTemplate.receiveAndConvert(&quot;ustc&quot;);</span><br><span class="line">      System.out.println(o.getClass());  &#x2F;&#x2F;class cn.edu.ustc.springboot.bean.Book</span><br><span class="line">      System.out.println(o);			&#x2F;&#x2F;Book&#123;name&#x3D;&#39;西游记&#39;, price&#x3D;23.2&#125;</span><br></pre></td></tr></table></figure>

<p>默认的消息转化器是SimpleMessageConverter，对于对象以jdk序列化方式存储，若要以Json方式存储对象，就要自定义消息转换器</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class AmqpConfig &#123;</span><br><span class="line">    @Bean</span><br><span class="line">    public MessageConverter messageConverter() &#123;</span><br><span class="line">        &#x2F;&#x2F;在容器中导入Json的消息转换器</span><br><span class="line">        return new Jackson2JsonMessageConverter();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>AmqpAdmin管理组件</strong></p>
<p> 可用于创建和删除exchange、binding和queue</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;创建Direct类型的Exchange</span><br><span class="line">amqpAdmin.declareExchange(new DirectExchange(&quot;admin.direct&quot;));</span><br><span class="line">&#x2F;&#x2F;创建Queue</span><br><span class="line">amqpAdmin.declareQueue(new Queue(&quot;admin.test&quot;));</span><br><span class="line">&#x2F;&#x2F;将创建的队列与Exchange绑定</span><br><span class="line">amqpAdmin.declareBinding(new Binding(&quot;admin.test&quot;, Binding.DestinationType.QUEUE,&quot;admin.direct&quot;,&quot;admin.test&quot;,null));</span><br></pre></td></tr></table></figure>

<p><strong>消息的监听</strong></p>
<p>在回调方法上标注@RabbitListener注解，并设置其属性queues，注册监听队列，当该队列收到消息时，标注方法遍会调用</p>
<p>可分别使用Message和保存消息所属对象进行消息接收，若使用Object对象进行消息接收，实际上接收到的也是Message</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class BookService &#123;</span><br><span class="line">    @RabbitListener(queues &#x3D; &#123;&quot;admin.test&quot;&#125;)</span><br><span class="line">    public void receive1(Book book)&#123;</span><br><span class="line">        System.out.println(&quot;收到消息：&quot;+book);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @RabbitListener(queues &#x3D; &#123;&quot;admin.test&quot;&#125;)</span><br><span class="line">    public void receive1(Object object)&#123;</span><br><span class="line">        System.out.println(&quot;收到消息：&quot;+object.getClass());</span><br><span class="line">        &#x2F;&#x2F;收到消息：class org.springframework.amqp.core.Message</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @RabbitListener(queues &#x3D; &#123;&quot;admin.test&quot;&#125;)</span><br><span class="line">    public void receive2(Message message)&#123;</span><br><span class="line">        System.out.println(&quot;收到消息&quot;+message.getHeaders()+&quot;---&quot;+message.getPayload());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="三-Spring-boot与检索"><a href="#三-Spring-boot与检索" class="headerlink" title="(三) Spring boot与检索"></a>(三) Spring boot与检索</h1><h2 id="一、-ElasticSearch入门"><a href="#一、-ElasticSearch入门" class="headerlink" title="一、 ElasticSearch入门"></a>一、 ElasticSearch入门</h2><h3 id="1-ES的简介"><a href="#1-ES的简介" class="headerlink" title="1. ES的简介"></a>1. ES的简介</h3><p><strong>简介</strong></p>
<p>我们的应用经常需要添加检索功能，开源的 ElasticSearch 是目前全文搜索引擎的首选。他可以快速的存储、搜索和分析海量数据。Spring Boot通过整合Spring Data ElasticSearch为我们提供了非常便捷的检索功能支持；<br>Elasticsearch是一个分布式搜索服务，提供Restful API，底层基于Lucene，采用多shard（分片）的方式保证数据安全，并且提供自动resharding的功能，github等大型的站点也是采用了ElasticSearch作为其搜索服务。</p>
<p><strong>概念</strong></p>
<p>员工文档 的形式存储为例：一个<strong>文档</strong>代表一个<strong>员工数据</strong>。存储数据到ElasticSearch 的行为叫做 <strong>索引</strong> ，但在索引一个文档之前，需要确定将文档存储在哪里。</p>
<p>一个 ElasticSearch 集群可以包含多个 <strong>索引</strong> ，相应的每个索引可以包含多个 <strong>类型</strong> 。 这些不同的类型存储着多个 文<strong>档</strong> ，每个文档又有 多个 <strong>属性</strong> 。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">索引（名词）：</span><br><span class="line"></span><br><span class="line">如前所述，一个 *索引* 类似于传统关系数据库中的一个 *数据库* ，是一个存储关系型文档的地方。 *索引* (*index*) 的复数词为 *indices* 或 *indexes* 。</span><br><span class="line"></span><br><span class="line">索引（动词）：</span><br><span class="line"></span><br><span class="line">*索引一个文档* 就是存储一个文档到一个 *索引* （名词）中以便被检索和查询。这非常类似于 SQL 语句中的 &#96;INSERT&#96; 关键词，除了文档已存在时，新文档会替换旧文档情况之外。</span><br></pre></td></tr></table></figure>

<p>类似关系：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-	索引---数据库</span><br><span class="line">-	类型---表</span><br><span class="line">-	文档---表中的记录</span><br><span class="line">-	属性---列</span><br></pre></td></tr></table></figure>

<p><a href="https://niceseason.github.io/images/Snipaste_2020-04-11_23-25-26.png" target="_blank" rel="noopener"><img src="https://niceseason.github.io/images/Snipaste_2020-04-11_23-25-26.png" alt="img"></a></p>
<h3 id="2-ES的安装与运行"><a href="#2-ES的安装与运行" class="headerlink" title="2. ES的安装与运行"></a>2. ES的安装与运行</h3><p>与ES交互</p>
<ul>
<li><p>9200端口</p>
<p> RESTful API通过HTTP通信</p>
</li>
<li><p>9300端口</p>
<p> Java客户端与ES的原生传输协议和集群交互</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 拉取ES镜像</span><br><span class="line">docker pull elasticsearch:7.6.1</span><br><span class="line">#运行ES</span><br><span class="line">docker run -e &quot;discovery.type&#x3D;single-node&quot; -e ES_JAVA_OPTS&#x3D;&quot;-Xms256m -Xmx256m&quot; -d -p 9200:9200 -p 9300:9300 --name ES03 41072cdeebc5</span><br></pre></td></tr></table></figure>

<p><code>ES_JAVA_OPTS</code>指定java虚拟机相关参数</p>
<p> <code>-Xms256m</code> 初始堆内存大小为256m</p>
<p> <code>-Xmx256m</code> 最大堆内存大小为256m</p>
<p><code>discovery.type=single-node</code> 设置为单点启动</p>
<h3 id="3-ES的基础入门"><a href="#3-ES的基础入门" class="headerlink" title="3. ES的基础入门"></a>3. ES的基础入门</h3><p><strong>案例：创建一个员工目录，并支持各类型检索</strong></p>
<p><strong>索引员工文档</strong></p>
<p>对于员工目录，我们将做如下操作：</p>
<ul>
<li>每个员工索引一个文档，文档包含该员工的所有信息。</li>
<li>每个文档都将是 <code>employee</code> <em>类型</em> 。</li>
<li>该类型位于 <em>索引</em> <code>megacorp</code> 内。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PUT &#x2F;megacorp&#x2F;employee&#x2F;1</span><br><span class="line">&#123;</span><br><span class="line">    &quot;first_name&quot; : &quot;John&quot;,</span><br><span class="line">    &quot;last_name&quot; :  &quot;Smith&quot;,</span><br><span class="line">    &quot;age&quot; :        25,</span><br><span class="line">    &quot;about&quot; :      &quot;I love to go rock climbing&quot;,</span><br><span class="line">    &quot;interests&quot;: [ &quot;sports&quot;, &quot;music&quot; ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，路径 <code>/megacorp/employee/1</code> 包含了三部分的信息：</p>
<ul>
<li><p><strong><code>megacorp</code></strong></p>
<p>索引名称</p>
</li>
<li><p><strong><code>employee</code></strong></p>
<p>类型名称</p>
</li>
<li><p><strong><code>1</code></strong></p>
<p>特定雇员的ID</p>
</li>
</ul>
<p>请求体 —— JSON 文档 —— 包含了这位员工的所有详细信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;_index&quot;: &quot;megacorp&quot;,</span><br><span class="line">    &quot;_type&quot;: &quot;employee&quot;,</span><br><span class="line">    &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">    &quot;_version&quot;: 1,</span><br><span class="line">    &quot;result&quot;: &quot;created&quot;,</span><br><span class="line">    &quot;_shards&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: 2,</span><br><span class="line">        &quot;successful&quot;: 1,</span><br><span class="line">        &quot;failed&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;_seq_no&quot;: 0,</span><br><span class="line">    &quot;_primary_term&quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同理，添加更多员工</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PUT &#x2F;megacorp&#x2F;employee&#x2F;2</span><br><span class="line">&#123;</span><br><span class="line">    &quot;first_name&quot; :  &quot;Jane&quot;,</span><br><span class="line">    &quot;last_name&quot; :   &quot;Smith&quot;,</span><br><span class="line">    &quot;age&quot; :         32,</span><br><span class="line">    &quot;about&quot; :       &quot;I like to collect rock albums&quot;,</span><br><span class="line">    &quot;interests&quot;:  [ &quot;music&quot; ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT &#x2F;megacorp&#x2F;employee&#x2F;3</span><br><span class="line">&#123;</span><br><span class="line">    &quot;first_name&quot; :  &quot;Douglas&quot;,</span><br><span class="line">    &quot;last_name&quot; :   &quot;Fir&quot;,</span><br><span class="line">    &quot;age&quot; :         35,</span><br><span class="line">    &quot;about&quot;:        &quot;I like to build cabinets&quot;,</span><br><span class="line">    &quot;interests&quot;:  [ &quot;forestry&quot; ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>检索文档</strong></p>
<p>HTTP <code>GET</code> 请求并指定文档的地址——索引库、类型和ID。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET &#x2F;megacorp&#x2F;employee&#x2F;1</span><br></pre></td></tr></table></figure>

<p>返回数据</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;_index&quot;: &quot;megacorp&quot;,</span><br><span class="line">    &quot;_type&quot;: &quot;employee&quot;,</span><br><span class="line">    &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">    &quot;_version&quot;: 1,</span><br><span class="line">    &quot;_seq_no&quot;: 0,</span><br><span class="line">    &quot;_primary_term&quot;: 1,</span><br><span class="line">    &quot;found&quot;: true,</span><br><span class="line">    &quot;_source&quot;: &#123;</span><br><span class="line">        &quot;first_name&quot;: &quot;John&quot;,</span><br><span class="line">        &quot;last_name&quot;: &quot;Smith&quot;,</span><br><span class="line">        &quot;age&quot;: 25,</span><br><span class="line">        &quot;about&quot;: &quot;I love to go rock climbing&quot;,</span><br><span class="line">        &quot;interests&quot;: [</span><br><span class="line">            &quot;sports&quot;,</span><br><span class="line">            &quot;music&quot;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将 HTTP 命令由 <code>PUT</code> 改为 <code>GET</code> 可以用来检索文档，同样的，可以使用 <code>DELETE</code> 命令来删除文档，以及使用 <code>HEAD</code> 指令来检查文档是否存在。如果想更新已存在的文档，只需再次 <code>PUT</code> 。</p>
<p><strong>轻量搜索</strong></p>
<p>搜索所有雇员：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET &#x2F;megacorp&#x2F;employee&#x2F;_search</span><br></pre></td></tr></table></figure>

<p>返回数据</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;took&quot;: 46,</span><br><span class="line">    &quot;timed_out&quot;: false,</span><br><span class="line">    &quot;_shards&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: 1,</span><br><span class="line">        &quot;successful&quot;: 1,</span><br><span class="line">        &quot;skipped&quot;: 0,</span><br><span class="line">        &quot;failed&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;hits&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: &#123;</span><br><span class="line">            &quot;value&quot;: 3,</span><br><span class="line">            &quot;relation&quot;: &quot;eq&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;max_score&quot;: 1,</span><br><span class="line">        &quot;hits&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;megacorp&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;employee&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">                &quot;_score&quot;: 1,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;first_name&quot;: &quot;John&quot;,</span><br><span class="line">                    &quot;last_name&quot;: &quot;Smith&quot;,</span><br><span class="line">                    &quot;age&quot;: 25,</span><br><span class="line">                    &quot;about&quot;: &quot;I love to go rock climbing&quot;,</span><br><span class="line">                    &quot;interests&quot;: [</span><br><span class="line">                        &quot;sports&quot;,</span><br><span class="line">                        &quot;music&quot;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;megacorp&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;employee&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;2&quot;,</span><br><span class="line">                &quot;_score&quot;: 1,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;first_name&quot;: &quot;Jane&quot;,</span><br><span class="line">                    &quot;last_name&quot;: &quot;Smith&quot;,</span><br><span class="line">                    &quot;age&quot;: 32,</span><br><span class="line">                    &quot;about&quot;: &quot;I like to collect rock albums&quot;,</span><br><span class="line">                    &quot;interests&quot;: [</span><br><span class="line">                        &quot;music&quot;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;megacorp&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;employee&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;3&quot;,</span><br><span class="line">                &quot;_score&quot;: 1,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;first_name&quot;: &quot;Douglas&quot;,</span><br><span class="line">                    &quot;last_name&quot;: &quot;Fir&quot;,</span><br><span class="line">                    &quot;age&quot;: 35,</span><br><span class="line">                    &quot;about&quot;: &quot;I like to build cabinets&quot;,</span><br><span class="line">                    &quot;interests&quot;: [</span><br><span class="line">                        &quot;forestry&quot;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回结果包括三个文档，放在数据<code>hits</code>中。</p>
<p>搜索姓氏为 <code>Smith</code> 的雇员</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET &#x2F;megacorp&#x2F;employee&#x2F;_search?q&#x3D;last_name:Smith</span><br></pre></td></tr></table></figure>

<p>在请求路径中使用 <code>_search</code> 端点，并将查询本身赋值给参数 <code>q=</code> 。返回结果给出了所有的 Smith：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;took&quot;: 23,</span><br><span class="line">    &quot;timed_out&quot;: false,</span><br><span class="line">    &quot;_shards&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: 1,</span><br><span class="line">        &quot;successful&quot;: 1,</span><br><span class="line">        &quot;skipped&quot;: 0,</span><br><span class="line">        &quot;failed&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;hits&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: &#123;</span><br><span class="line">            &quot;value&quot;: 2,</span><br><span class="line">            &quot;relation&quot;: &quot;eq&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;max_score&quot;: 0.4700036,</span><br><span class="line">        &quot;hits&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;megacorp&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;employee&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">                &quot;_score&quot;: 0.4700036,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;first_name&quot;: &quot;John&quot;,</span><br><span class="line">                    &quot;last_name&quot;: &quot;Smith&quot;,</span><br><span class="line">                    &quot;age&quot;: 25,</span><br><span class="line">                    &quot;about&quot;: &quot;I love to go rock climbing&quot;,</span><br><span class="line">                    &quot;interests&quot;: [</span><br><span class="line">                        &quot;sports&quot;,</span><br><span class="line">                        &quot;music&quot;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;megacorp&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;employee&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;2&quot;,</span><br><span class="line">                &quot;_score&quot;: 0.4700036,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;first_name&quot;: &quot;Jane&quot;,</span><br><span class="line">                    &quot;last_name&quot;: &quot;Smith&quot;,</span><br><span class="line">                    &quot;age&quot;: 32,</span><br><span class="line">                    &quot;about&quot;: &quot;I like to collect rock albums&quot;,</span><br><span class="line">                    &quot;interests&quot;: [</span><br><span class="line">                        &quot;music&quot;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用查询表达式搜索</strong></p>
<p>Query-string 搜索通过命令非常方便地进行临时性的即席搜索 ，但它有自身的局限性。Elasticsearch 提供一个丰富灵活的查询语言叫做 <em>查询表达式</em> ， 它支持构建更加复杂和健壮的查询。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET &#x2F;megacorp&#x2F;employee&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;match&quot; : &#123;</span><br><span class="line">            &quot;last_name&quot; : &quot;Smith&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回效果与之前一样</p>
<p><strong>更复杂的搜索</strong></p>
<p>同样搜索姓氏为 Smith 的员工，但这次我们只需要年龄大于 30 的</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET &#x2F;megacorp&#x2F;employee&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;bool&quot;: &#123;</span><br><span class="line">            &quot;must&quot;: &#123;</span><br><span class="line">                &quot;match&quot; : &#123;</span><br><span class="line">                    &quot;last_name&quot; : &quot;smith&quot; </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;filter&quot;: &#123;</span><br><span class="line">                &quot;range&quot; : &#123;</span><br><span class="line">                    &quot;age&quot; : &#123; &quot;gt&quot; : 30 &#125; </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>全文搜索</strong></p>
<p>搜索下所有喜欢攀岩（rock climbing）的员工：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET &#x2F;megacorp&#x2F;employee&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;match&quot; : &#123;</span><br><span class="line">            &quot;about&quot; : &quot;rock climbing&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回结果</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;took&quot;: 13,</span><br><span class="line">    &quot;timed_out&quot;: false,</span><br><span class="line">    &quot;_shards&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: 1,</span><br><span class="line">        &quot;successful&quot;: 1,</span><br><span class="line">        &quot;skipped&quot;: 0,</span><br><span class="line">        &quot;failed&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;hits&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: &#123;</span><br><span class="line">            &quot;value&quot;: 2,</span><br><span class="line">            &quot;relation&quot;: &quot;eq&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;max_score&quot;: 1.4167401,</span><br><span class="line">        &quot;hits&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;megacorp&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;employee&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">                &quot;_score&quot;: 1.4167401,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;first_name&quot;: &quot;John&quot;,</span><br><span class="line">                    &quot;last_name&quot;: &quot;Smith&quot;,</span><br><span class="line">                    &quot;age&quot;: 25,</span><br><span class="line">                    &quot;about&quot;: &quot;I love to go rock climbing&quot;,</span><br><span class="line">                    &quot;interests&quot;: [</span><br><span class="line">                        &quot;sports&quot;,</span><br><span class="line">                        &quot;music&quot;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;megacorp&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;employee&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;2&quot;,</span><br><span class="line">                &quot;_score&quot;: 0.4589591,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;first_name&quot;: &quot;Jane&quot;,</span><br><span class="line">                    &quot;last_name&quot;: &quot;Smith&quot;,</span><br><span class="line">                    &quot;age&quot;: 32,</span><br><span class="line">                    &quot;about&quot;: &quot;I like to collect rock albums&quot;,</span><br><span class="line">                    &quot;interests&quot;: [</span><br><span class="line">                        &quot;music&quot;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到返回结果还带有相关性得分<code>_score</code></p>
<p><strong>短语搜索</strong></p>
<p><strong>精确匹配</strong>一系列单词或者<em>短语</em> 。 比如， 执行这样一个查询，短语 “rock climbing” 的形式紧挨着的雇员记录。</p>
<p>为此对 <code>match</code> 查询稍作调整，使用一个叫做 <code>match_phrase</code> 的查询</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET &#x2F;megacorp&#x2F;employee&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;match_phrase&quot; : &#123;</span><br><span class="line">            &quot;about&quot; : &quot;rock climbing&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>高亮搜索</strong></p>
<p>每个搜索结果中 <em>高亮</em> 部分文本片段</p>
<p>再次执行前面的查询，并增加一个新的 <code>highlight</code> 参数：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET &#x2F;megacorp&#x2F;employee&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;match_phrase&quot; : &#123;</span><br><span class="line">            &quot;about&quot; : &quot;rock climbing&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;highlight&quot;: &#123;</span><br><span class="line">        &quot;fields&quot; : &#123;</span><br><span class="line">            &quot;about&quot; : &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回结果</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">		...</span><br><span class="line">    </span><br><span class="line">        &quot;hits&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;megacorp&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;employee&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">                &quot;_score&quot;: 1.4167401,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;first_name&quot;: &quot;John&quot;,</span><br><span class="line">                    &quot;last_name&quot;: &quot;Smith&quot;,</span><br><span class="line">                    &quot;age&quot;: 25,</span><br><span class="line">                    &quot;about&quot;: &quot;I love to go rock climbing&quot;,</span><br><span class="line">                    &quot;interests&quot;: [</span><br><span class="line">                        &quot;sports&quot;,</span><br><span class="line">                        &quot;music&quot;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;highlight&quot;: &#123;</span><br><span class="line">                    &quot;about&quot;: [</span><br><span class="line">                        &quot;I love to go &lt;em&gt;rock&lt;&#x2F;em&gt; &lt;em&gt;climbing&lt;&#x2F;em&gt;&quot;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果中还多了一个叫做 <code>highlight</code> 的部分。这个部分包含了 <code>about</code> 属性匹配的文本片段，并以 HTML 标签 `` 封装</p>
<h2 id="二、-Springboot整合ElasticSearch"><a href="#二、-Springboot整合ElasticSearch" class="headerlink" title="二、 Springboot整合ElasticSearch"></a>二、 Springboot整合ElasticSearch</h2><h3 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h3><p>SpringBoot默认支持两种技术来和ES交互；</p>
<ul>
<li><p>Jest（默认不生效）</p>
<ul>
<li>需要导入jest的工具包（io.searchbox.client.JestClient）</li>
<li>从springboot 2.2.0以后被弃用</li>
</ul>
</li>
<li><p>SpringData ElasticSearch</p>
<p>版本适配说明</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>Spring Data Elasticsearch</th>
<th>Elasticsearch</th>
</tr>
</thead>
<tbody><tr>
<td>3.2.x</td>
<td>6.8.1</td>
</tr>
<tr>
<td>3.1.x</td>
<td>6.2.2</td>
</tr>
<tr>
<td>3.0.x</td>
<td>5.5.0</td>
</tr>
<tr>
<td>2.1.x</td>
<td>2.4.0</td>
</tr>
<tr>
<td>2.0.x</td>
<td>2.2.0</td>
</tr>
<tr>
<td>1.3.x</td>
<td>1.5.2</td>
</tr>
</tbody></table>
<p>Springboot 2.2.6对应于 Spring Data Elasticsearch 3.2.6，即适配Elasticsearch 6.8.1</p>
<h3 id="2-环境搭建"><a href="#2-环境搭建" class="headerlink" title="2. 环境搭建"></a>2. 环境搭建</h3><p>编写文件对应Javabean，指定索引名和类型</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Document(indexName &#x3D; &quot;ustc&quot;,type &#x3D; &quot;book&quot;)</span><br><span class="line">public class Book &#123;</span><br><span class="line">    private Integer id;</span><br><span class="line">    private String bookName;</span><br><span class="line">    private String author;</span><br><span class="line"></span><br><span class="line">    public Integer getId() &#123;</span><br><span class="line">        return id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setId(Integer id) &#123;</span><br><span class="line">        this.id &#x3D; id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getBookName() &#123;</span><br><span class="line">        return bookName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setBookName(String bookName) &#123;</span><br><span class="line">        this.bookName &#x3D; bookName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getAuthor() &#123;</span><br><span class="line">        return author;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setAuthor(String author) &#123;</span><br><span class="line">        this.author &#x3D; author;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;Book&#123;&quot; +</span><br><span class="line">                &quot;id&#x3D;&quot; + id +</span><br><span class="line">                &quot;, bookName&#x3D;&#39;&quot; + bookName + &#39;\&#39;&#39; +</span><br><span class="line">                &quot;, author&#x3D;&#39;&quot; + author + &#39;\&#39;&#39; +</span><br><span class="line">                &#39;&#125;&#39;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-ElasticSearch客户端"><a href="#3-ElasticSearch客户端" class="headerlink" title="3. ElasticSearch客户端"></a>3. ElasticSearch客户端</h3><ul>
<li><p><strong>Transport Client</strong></p>
<p>在ES7中已经被弃用，将在ES8被移除</p>
</li>
<li><p><strong>High Level REST Client</strong></p>
<p>ES的默认客户端</p>
</li>
<li><p><strong>Reactive Client</strong></p>
<p>非官方驱动，基于WebClient</p>
</li>
</ul>
<p>下面以REST客户端为例说明ES的使用</p>
<p><strong>配置主机地址</strong></p>
<p>方式一 配置类配置</p>
<p>注意：这种方式底层依赖于Http相关类，因此要导入web相关jar包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">static class Config &#123;</span><br><span class="line">  @Bean</span><br><span class="line">  RestHighLevelClient client() &#123;</span><br><span class="line"></span><br><span class="line">    ClientConfiguration clientConfiguration &#x3D; ClientConfiguration.builder() </span><br><span class="line">      .connectedTo(&quot;localhost:9200&quot;)</span><br><span class="line">      .build();</span><br><span class="line"></span><br><span class="line">    return RestClients.create(clientConfiguration).rest();                  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>方式二 spring配置文件指定</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">spring.elasticsearch.rest.uris&#x3D;http:&#x2F;&#x2F;192.168.31.162:9200</span><br></pre></td></tr></table></figure>

<p><strong>在测试类中注入客户端</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Autowired</span><br><span class="line">RestHighLevelClient highLevelClient;</span><br></pre></td></tr></table></figure>

<p><strong>创建索引</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">IndexRequest request &#x3D; new IndexRequest(&quot;ustc&quot;, &quot;book&quot;,</span><br><span class="line">        UUID.randomUUID().toString())</span><br><span class="line">        .source(Collections.singletonMap(&quot;feature&quot;, &quot;high-level-rest-client&quot;))</span><br><span class="line">        .setRefreshPolicy(WriteRequest.RefreshPolicy.IMMEDIATE);</span><br><span class="line">IndexResponse index &#x3D; highLevelClient.index(request, RequestOptions.DEFAULT);</span><br><span class="line">System.out.println(index.toString());</span><br></pre></td></tr></table></figure>

<p>下面为创建索引</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;_index&quot;: &quot;ustc&quot;,</span><br><span class="line">    &quot;_type&quot;: &quot;book&quot;,</span><br><span class="line">    &quot;_id&quot;: &quot;0dc9f47a-7913-481d-a36d-e8f034a6a3ac&quot;,</span><br><span class="line">    &quot;_score&quot;: 1,</span><br><span class="line">    &quot;_source&quot;: &#123;</span><br><span class="line">        &quot;feature&quot;: &quot;high-level-rest-client&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>得到索引</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;分别指定要获取的索引、类型、id</span><br><span class="line">GetRequest getRequest &#x3D; new GetRequest(&quot;ustc&quot;,&quot;book&quot;,&quot;0dc9f47a-7913-481d-a36d-e8f034a6a3ac&quot;);</span><br><span class="line">GetResponse documentFields &#x3D; highLevelClient.get(getRequest, RequestOptions.DEFAULT);</span><br><span class="line">System.out.println(documentFields);</span><br></pre></td></tr></table></figure>

<h3 id="4-ElasticsearchRestTemplate"><a href="#4-ElasticsearchRestTemplate" class="headerlink" title="4. ElasticsearchRestTemplate"></a>4. ElasticsearchRestTemplate</h3><p>ES有两个模板，分别为<code>ElasticsearchRestTemplate</code>和<code>ElasticsearchTemplate</code></p>
<p>分别对应于<strong>High Level REST Client</strong>和<strong>Transport Client</strong>(弃用)，两个模板都实现了<code>ElasticsearchOperations</code>接口，因此使用时我们一般使用<code>ElasticsearchOperations</code>，具体实现方式由底层决定。</p>
<p>由于在<code>AbstractElasticsearchConfiguration</code>中已经向容器中导入了<code>ElasticsearchRestTemplate</code>，因此我们使用时可以直接注入</p>
<p><strong>注入模板</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Autowired</span><br><span class="line">ElasticsearchOperations elasticsearchOperations;</span><br></pre></td></tr></table></figure>

<p><strong>保存索引</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Book book &#x3D; new Book();</span><br><span class="line">book.setAuthor(&quot;路遥&quot;);</span><br><span class="line">book.setBookName(&quot;平凡的世界&quot;);</span><br><span class="line">book.setId(1);</span><br><span class="line">IndexQuery indexQuery &#x3D; new IndexQueryBuilder()</span><br><span class="line">    .withId(book.getId().toString())</span><br><span class="line">    .withObject(book)</span><br><span class="line">    .build();</span><br><span class="line">String index &#x3D; elasticsearchOperations.index(indexQuery);</span><br></pre></td></tr></table></figure>

<p><strong>查询索引</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Book book &#x3D; elasticsearchOperations.queryForObject(GetQuery.getById(&quot;1&quot;), Book.class);</span><br></pre></td></tr></table></figure>

<h3 id="5-Elasticsearch-Repositories"><a href="#5-Elasticsearch-Repositories" class="headerlink" title="5. Elasticsearch Repositories"></a>5. Elasticsearch Repositories</h3><p>编写相关Repository并继承Repository或ElasticsearchRepository，泛型分别为&lt;查询类，主键&gt;</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public interface BookRepository extends Repository&lt;Book,Integer&gt; &#123;</span><br><span class="line">    List&lt;Book&gt; findByBookNameAndAuthor(String bookName, String author);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询的方法仅需按照<strong>一定规则</strong>命名即可实现功能，<strong>无需编写实现</strong>，如上findByBookNameAndAuthor()方法相当于ES的json查询</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;bool&quot; : &#123;</span><br><span class="line">            &quot;must&quot; : [</span><br><span class="line">                &#123; &quot;query_string&quot; : &#123; &quot;query&quot; : &quot;?&quot;, &quot;fields&quot; : [ &quot;bookName&quot; ] &#125; &#125;,</span><br><span class="line">                &#123; &quot;query_string&quot; : &#123; &quot;query&quot; : &quot;?&quot;, &quot;fields&quot; : [ &quot;author&quot; ] &#125; &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://docs.spring.io/spring-data/elasticsearch/docs/3.2.6.RELEASE/reference/html/#elasticsearch.repositories" target="_blank" rel="noopener">更多命名规则见本文档</a></p>
<p><strong>@Query</strong></p>
<p>此外，还可以使用<code>@Query</code>自定义请求json</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">interface BookRepository extends ElasticsearchRepository&lt;Book, String&gt; &#123;</span><br><span class="line">    @Query(&quot;&#123;\&quot;match\&quot;: &#123;\&quot;name\&quot;: &#123;\&quot;query\&quot;: \&quot;?0\&quot;&#125;&#125;&#125;&quot;)</span><br><span class="line">    Page&lt;Book&gt; findByName(String name,Pageable pageable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>若参数为John，相当于请求体为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;name&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: &quot;John&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>更多ES与springboot整合内容见<a href="https://docs.spring.io/spring-data/elasticsearch/docs/3.2.6.RELEASE/reference/html/#new-features" target="_blank" rel="noopener">官方文档</a></strong></p>
<h1 id="四-Spring-boot与任务"><a href="#四-Spring-boot与任务" class="headerlink" title="(四) Spring boot与任务"></a>(四) Spring boot与任务</h1><h2 id="一、异步任务"><a href="#一、异步任务" class="headerlink" title="一、异步任务"></a>一、异步任务</h2><p>在Java应用中，绝大多数情况下都是通过同步的方式来实现交互处理的；但是在处理与第三方系统交互的时候，容易造成响应迟缓的情况，之前大部分都是使用多线程来完成此类任务，springboot中可以用异步任务解决。</p>
<p><strong>两个注解：</strong></p>
<p><code>@Async</code> 在需要异步执行的方法上标注注解</p>
<p><code>@EnableAsync</code> 在主类上标注开启异步任务支持</p>
<p>开启异步任务后，当controller层调用该方法会直接返回结果，该任务异步执行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class AsyncService &#123;</span><br><span class="line">    @Async</span><br><span class="line">    public void sayHello() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(3000);</span><br><span class="line">            System.out.println(&quot;hello async task!&quot;);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="二、-定时任务"><a href="#二、-定时任务" class="headerlink" title="二、 定时任务"></a>二、 定时任务</h2><p>项目开发中经常需要执行一些定时任务，比如需要在每天凌晨时候，分析一次前一天的日志信息。Spring为我们提供了异步执行任务调度的方式，提供TaskExecutor 、TaskScheduler 接口。</p>
<p><strong>两个注解：</strong></p>
<p><code>@EnableScheduling</code> 标注在主类，开启对定时任务支持</p>
<p><code>@Scheduled</code> 标注在执行的方法上，并制定cron属性</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class ScheduleService &#123;</span><br><span class="line">    @Scheduled(cron &#x3D; &quot;0,1,2,3,4,5,30,50 * * * * 0-7&quot;)</span><br><span class="line">    public void schedule() &#123;</span><br><span class="line">        System.out.println(&quot;I am executing..&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>cron</strong>表达式：</p>
<p>second(秒), minute（分）, hour（时）, day of month（日）, month（月）, day of week（周几）.</p>
<p><code>0 0/5 14,18 * * ?</code> 每天14点整，和18点整，每隔5分钟执行一次</p>
<p><code>0 15 10 ? * 1-6</code> 每个月的周一至周六10:15分执行一次</p>
<p><code>0 0 2 ? * 6L</code> 每个月的最后一个周六凌晨2点执行一次</p>
<p><code>0 0 2 LW * ?</code> 每个月的最后一个工作日凌晨2点执行一次</p>
<p><code>0 0 2-4 ? * 1#1</code> 每个月的第一个周一凌晨2点到4点期间，每个整点都执行一次；</p>
<table>
<thead>
<tr>
<th align="left"><strong>字段</strong></th>
<th align="left"><strong>允许值</strong></th>
<th align="left"><strong>允许的特殊字符</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">秒</td>
<td align="left">0-59</td>
<td align="left">, - * /</td>
</tr>
<tr>
<td align="left">分</td>
<td align="left">0-59</td>
<td align="left">, - * /</td>
</tr>
<tr>
<td align="left">小时</td>
<td align="left">0-23</td>
<td align="left">, - * /</td>
</tr>
<tr>
<td align="left">日期</td>
<td align="left">1-31</td>
<td align="left">, - * ? / L W C</td>
</tr>
<tr>
<td align="left">月份</td>
<td align="left">1-12</td>
<td align="left">, - * /</td>
</tr>
<tr>
<td align="left">星期</td>
<td align="left">0-7或SUN-SAT 0,7是SUN</td>
<td align="left">, - * ? / L C #</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="left"><strong>特殊字符</strong></th>
<th align="left"><strong>代表含义</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">,</td>
<td align="left">枚举</td>
</tr>
<tr>
<td align="left">-</td>
<td align="left">区间</td>
</tr>
<tr>
<td align="left">*</td>
<td align="left">任意</td>
</tr>
<tr>
<td align="left">/</td>
<td align="left">步长</td>
</tr>
<tr>
<td align="left">?</td>
<td align="left">日/星期冲突匹配</td>
</tr>
<tr>
<td align="left">L</td>
<td align="left">最后</td>
</tr>
<tr>
<td align="left">W</td>
<td align="left">工作日</td>
</tr>
<tr>
<td align="left">C</td>
<td align="left">和calendar联系后计算过的值</td>
</tr>
<tr>
<td align="left">#</td>
<td align="left">星期，4#2，第2个星期四</td>
</tr>
</tbody></table>
<h2 id="三、-邮件任务"><a href="#三、-邮件任务" class="headerlink" title="三、 邮件任务"></a>三、 邮件任务</h2><p>springboot自动配置包中<code>MailSenderAutoConfiguration</code>通过<code>@Import</code>注解向容器中导入了<code>MailSenderJndiConfiguration</code>,而<code>MailSenderJndiConfiguration</code>向容器中导入了<code>JavaMailSenderImpl</code>类，我们可以使用该类发送邮件</p>
<p><strong>配置文件</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">spring.mail.username&#x3D;邮箱用户名</span><br><span class="line">spring.mail.password&#x3D;邮箱密码或授权码</span><br><span class="line">spring.mail.host&#x3D;smtp.example.com</span><br></pre></td></tr></table></figure>

<p><strong>自动注入</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Autowired</span><br><span class="line">private JavaMailSenderImpl javaMailSender;</span><br></pre></td></tr></table></figure>

<p><strong>简单邮件发送</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SimpleMailMessage message &#x3D; new SimpleMailMessage();</span><br><span class="line">&#x2F;&#x2F;设置主题和内容</span><br><span class="line">message.setSubject(&quot;今天开会&quot;);</span><br><span class="line">message.setText(&quot;物质楼555开会，不要迟到&quot;);</span><br><span class="line">&#x2F;&#x2F;设置发送方和接收方</span><br><span class="line">message.setFrom(&quot;xxx@163.com&quot;);</span><br><span class="line">message.setTo(&quot;xxx@qq.com&quot;);</span><br><span class="line"></span><br><span class="line">javaMailSender.send(message);</span><br></pre></td></tr></table></figure>

<p><strong>复杂邮件发送</strong></p>
<p>带有附件或html页面的邮件</p>
<p><strong>两个设置</strong></p>
<p><code>new MimeMessageHelper(message,true)</code> 设置multipart=true，开启对内联元素和附件的支持</p>
<p><code>helper.setText(&quot;xxxx&quot;,true)</code> html=ture，设置content type=text/html，默认为text/plain</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MimeMessage message &#x3D; javaMailSender.createMimeMessage();</span><br><span class="line">&#x2F;&#x2F;multipart&#x3D;true</span><br><span class="line">&#x2F;&#x2F;开启对内联元素和附件的支持</span><br><span class="line">MimeMessageHelper helper &#x3D; new MimeMessageHelper(message,true);</span><br><span class="line"></span><br><span class="line">helper.setSubject(&quot;今天开会&quot;);</span><br><span class="line">&#x2F;&#x2F;html&#x3D;ture</span><br><span class="line">&#x2F;&#x2F;设置content type&#x3D;text&#x2F;html，默认为text&#x2F;plain</span><br><span class="line">helper.setText(&quot;&lt;b style&#x3D;&#39;color:red&#39;&gt;物质楼555开会，不要迟到&lt;&#x2F;b&gt;&quot;,true);</span><br><span class="line"></span><br><span class="line">helper.setFrom(&quot;hongshengmo@163.com&quot;);</span><br><span class="line">helper.setTo(&quot;1043245239@qq.com&quot;);</span><br><span class="line">&#x2F;&#x2F;设置附件</span><br><span class="line">helper.addAttachment(&quot;2.png&quot;,new File(&quot;D:\\Works\\Note\\images\\图片2.png&quot;));</span><br><span class="line">helper.addAttachment(&quot;3.png&quot;,new File(&quot;D:\\Works\\Note\\images\\图片3.png&quot;));</span><br><span class="line">javaMailSender.send(message);</span><br></pre></td></tr></table></figure>

<h1 id="五-Spring-boot与安全"><a href="#五-Spring-boot与安全" class="headerlink" title="(五) Spring boot与安全"></a>(五) Spring boot与安全</h1><h2 id="一、安全"><a href="#一、安全" class="headerlink" title="一、安全"></a>一、安全</h2><p>应用程序的两个主要区域是“认证”和“授权”（或者访问控制），这两个主要区域是安全的两个目标。 身份验证意味着<strong>确认您自己的身份</strong>，而授权意味着<strong>授予对系统的访问权限</strong></p>
<p><strong>认证</strong></p>
<p>身份验证是关于验证您的凭据，如用户名/用户ID和密码，以验证您的身份。系统确定您是否就是您所说的使用凭据。在公共和专用网络中，系统通过登录密码验证用户身份。身份验证通常通过用户名和密码完成，</p>
<p><strong>授权</strong></p>
<p>另一方面，授权发生在系统成功验证您的身份后，最终会授予您访问资源（如信息，文件，数据库，资金，位置，几乎任何内容）的完全权限。简单来说，授权决定了您访问系统的能力以及达到的程度。验证成功后，系统验证您的身份后，即可授权您访问系统资源。</p>
<h2 id="二、Spring-Security"><a href="#二、Spring-Security" class="headerlink" title="二、Spring Security"></a>二、Spring Security</h2><p>Spring Security是针对Spring项目的安全框架，也是Spring Boot底层安全模块默认的技术选型。他可以实现强大的web安全控制。对于安全控制，我们仅需引入<code>spring-boot-starter-security</code>模块，进行少量的配置，即可实现强大的安全管理。</p>
<p><strong>WebSecurityConfigurerAdapter：自定义Security策略</strong></p>
<p>通过在配置类中继承该类重写<code>configure(HttpSecurity http)</code>方法来实现自定义策略</p>
<p><strong>@EnableWebSecurity：开启WebSecurity模式</strong></p>
<p>在配置类上标注<code>@EnableWebSecurity</code>开启WebSecurity模式</p>
<h2 id="三、-Springboot整合security"><a href="#三、-Springboot整合security" class="headerlink" title="三、 Springboot整合security"></a>三、 Springboot整合security</h2><h3 id="1-导入依赖"><a href="#1-导入依赖" class="headerlink" title="1. 导入依赖"></a>1. 导入依赖</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-security&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<p>导入spring security的包之后，默认情况所有应用访问认证授权，默认用户名user，密码为随机生成的uuid，启动时打印在控制台</p>
<h3 id="2-登录-注销"><a href="#2-登录-注销" class="headerlink" title="2. 登录/注销"></a>2. 登录/注销</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@EnableWebSecurity</span><br><span class="line">public class MySecurityConfig extends WebSecurityConfigurerAdapter &#123;</span><br><span class="line">    @Override</span><br><span class="line">    protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line">        &#x2F;&#x2F;根目录允许所有人访问，其他目录都需要对应角色</span><br><span class="line">        http.authorizeRequests().antMatchers(&quot;&#x2F;&quot;).permitAll()</span><br><span class="line">                .antMatchers(&quot;&#x2F;level1&#x2F;**&quot;).hasRole(&quot;VIP1&quot;)</span><br><span class="line">                .antMatchers(&quot;&#x2F;level2&#x2F;**&quot;).hasRole(&quot;VIP2&quot;)</span><br><span class="line">                .antMatchers(&quot;&#x2F;level3&#x2F;**&quot;).hasRole(&quot;VIP3&quot;);</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F;开启自动配置的登陆功能，效果，如果没有登陆，没有权限就会来到登陆页面</span><br><span class="line">        &#x2F;&#x2F;	&#x2F;login来到登陆页</span><br><span class="line">        &#x2F;&#x2F;	重定向到&#x2F;login?error表示登陆失败</span><br><span class="line">        http.formLogin();</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F;开启自动配置的注销功能</span><br><span class="line">        &#x2F;&#x2F;向&#x2F;logout发送post请求表示注销</span><br><span class="line">        http.logout();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时除了主页，点击其他的页面都会自动跳转到security自动生成的登录页面，<code>/login</code>来到登陆页,重定向到<code>/login?error</code>表示登陆失败；</p>
<p><code>http.logout()</code>开启自动配置的注销功能,向<code>/logout</code>发送post请求表示注销,需要在欢迎页加上注销表单，默认注销后自动跳转到登录页面，若想改变转发路径，可以通过<code>logoutSuccessUrl(url)</code>设置路径</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;form th:action&#x3D;&quot;@&#123;&#x2F;logout&#125;&quot; method&#x3D;&quot;post&quot;&gt;</span><br><span class="line">   &lt;input type&#x3D;&quot;submit&quot; value&#x3D;&quot;注销&quot;&gt;</span><br><span class="line">&lt;&#x2F;form&gt;</span><br></pre></td></tr></table></figure>

<h3 id="3-定义认证规则"><a href="#3-定义认证规则" class="headerlink" title="3. 定义认证规则"></a>3. 定义认证规则</h3><p>为了保证密码能安全存储，springboot内置<code>PasswordEncoder</code>对密码进行转码，默认密码编码器为<code>DelegatingPasswordEncoder</code>。在定义认证规则时，我们需要使用<code>PasswordEncoder</code>将密码转码，由于<code>withDefaultPasswordEncoder()</code>并非安全已被弃用，因此仅在测试中使用。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Bean</span><br><span class="line">public UserDetailsService users() &#123;</span><br><span class="line">    &#x2F;&#x2F;使用默认的PasswordEncoder</span><br><span class="line">    User.UserBuilder builder &#x3D; User.withDefaultPasswordEncoder();</span><br><span class="line">    &#x2F;&#x2F;定义账户用户名、密码、权限</span><br><span class="line">    UserDetails user1 &#x3D; builder.username(&quot;zhangsan&quot;)</span><br><span class="line">            .password(&quot;123456&quot;)</span><br><span class="line">            .roles(&quot;VIP1&quot;, &quot;VIP2&quot;)</span><br><span class="line">            .build();</span><br><span class="line">    UserDetails user2 &#x3D; builder.username(&quot;lisi&quot;)</span><br><span class="line">            .password(&quot;123456&quot;)</span><br><span class="line">            .roles(&quot;VIP3&quot;, &quot;VIP2&quot;)</span><br><span class="line">            .build();</span><br><span class="line">    UserDetails user3 &#x3D; builder.username(&quot;wangwu&quot;)</span><br><span class="line">            .password(&quot;123456&quot;)</span><br><span class="line">            .roles(&quot;VIP1&quot;, &quot;VIP3&quot;)</span><br><span class="line">            .build();</span><br><span class="line">    &#x2F;&#x2F;使用内存保存用户信息</span><br><span class="line">    return new InMemoryUserDetailsManager(user1,user2,user3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-自定义欢迎页"><a href="#4-自定义欢迎页" class="headerlink" title="4.自定义欢迎页"></a>4.自定义欢迎页</h3><p><strong>导入依赖</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.thymeleaf.extras&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;thymeleaf-extras-springsecurity5&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<p><strong>引入命名空间</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html xmlns:th&#x3D;&quot;http:&#x2F;&#x2F;www.thymeleaf.org&quot;</span><br><span class="line">     xmlns:sec&#x3D;&quot;http:&#x2F;&#x2F;www.thymeleaf.org&#x2F;extras&#x2F;spring-security&quot;&gt;</span><br></pre></td></tr></table></figure>

<p><strong>根据是否登录显示游客或用户信息</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!-- 未登录显示此div --&gt;</span><br><span class="line">&lt;div sec:authorize&#x3D;&quot;!isAuthenticated()&quot;&gt;</span><br><span class="line">   &lt;h2 align&#x3D;&quot;center&quot;&gt;游客您好，如果想查看武林秘籍 &lt;a th:href&#x3D;&quot;@&#123;&#x2F;userlogin&#125;&quot;&gt;请登录&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line">&lt;!-- 登录显示此div --&gt;</span><br><span class="line">&lt;div sec:authorize&#x3D;&quot;isAuthenticated()&quot;&gt;</span><br><span class="line">    &lt;!-- 显示用户名 --&gt;</span><br><span class="line">   &lt;h2&gt;尊敬的&lt;span th:text&#x3D;&quot;$&#123;#authentication.name&#125;&quot;&gt;&lt;&#x2F;span&gt;,您好！您的角色有：</span><br><span class="line">       &lt;!-- 显示用户角色 --&gt;</span><br><span class="line">      &lt;span th:text&#x3D;&quot;$&#123;#authentication.authorities&#125;&quot;&gt;&lt;&#x2F;span&gt;&lt;&#x2F;h2&gt;</span><br><span class="line">   &lt;form th:action&#x3D;&quot;@&#123;&#x2F;logout&#125;&quot; method&#x3D;&quot;post&quot;&gt;</span><br><span class="line">      &lt;input type&#x3D;&quot;submit&quot; value&#x3D;&quot;注销&quot;&gt;</span><br><span class="line">   &lt;&#x2F;form&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure>

<p><strong>根据角色类型显示信息</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!-- 具有VIP1的角色显示以下div --&gt;</span><br><span class="line">&lt;div sec:authorize&#x3D;&quot;hasRole(&#39;VIP1&#39;)&quot;&gt;</span><br><span class="line">   &lt;h3&gt;普通武功秘籍&lt;&#x2F;h3&gt;</span><br><span class="line">   &lt;ul&gt;</span><br><span class="line">      &lt;li&gt;&lt;a th:href&#x3D;&quot;@&#123;&#x2F;level1&#x2F;1&#125;&quot;&gt;罗汉拳&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;</span><br><span class="line">      &lt;li&gt;&lt;a th:href&#x3D;&quot;@&#123;&#x2F;level1&#x2F;2&#125;&quot;&gt;武当长拳&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;</span><br><span class="line">      &lt;li&gt;&lt;a th:href&#x3D;&quot;@&#123;&#x2F;level1&#x2F;3&#125;&quot;&gt;全真剑法&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;</span><br><span class="line">   &lt;&#x2F;ul&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure>

<p><a href="https://github.com/thymeleaf/thymeleaf-extras-springsecurity" target="_blank" rel="noopener">更多spring-security与thymeleaf整合教程</a></p>
<h3 id="5-自定义登录页-记住我"><a href="#5-自定义登录页-记住我" class="headerlink" title="5. 自定义登录页/记住我"></a>5. 自定义登录页/记住我</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line">    ...</span><br><span class="line">    &#x2F;&#x2F;定制登录页</span><br><span class="line">    http.formLogin()</span><br><span class="line">            .usernameParameter(&quot;user&quot;)  &#x2F;&#x2F;表单用户名name</span><br><span class="line">            .passwordParameter(&quot;pwd&quot;)   &#x2F;&#x2F;表单密码name</span><br><span class="line">            .loginPage(&quot;&#x2F;userlogin&quot;);   &#x2F;&#x2F;定制登陆页路径</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;开启记住我</span><br><span class="line">    http.rememberMe().</span><br><span class="line">        rememberMeParameter(&quot;rem&quot;);		&#x2F;&#x2F;设置表单记住我name值</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过<code>loginPage(url)</code>设置登录页路径后，在定制的登录页发送<code>post url</code>即为登录请求，并设置表单的<code>name</code>属性都为对应值；</p>
<p>通过勾选<code>记住我</code>，session退出后依然能通过<code>cookie</code>保存用户信息，下次免登陆</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;form th:action&#x3D;&quot;@&#123;&#x2F;userlogin&#125;&quot; method&#x3D;&quot;post&quot;&gt;</span><br><span class="line">   用户名:&lt;input name&#x3D;&quot;user&quot;&#x2F;&gt;&lt;br&gt;</span><br><span class="line">   密码:&lt;input name&#x3D;&quot;pwd&quot;&gt;&lt;br&#x2F;&gt;</span><br><span class="line">   &lt;input type&#x3D;&quot;checkbox&quot; name&#x3D;&quot;rem&quot;&gt;记住我&lt;br&gt;</span><br><span class="line">   &lt;input type&#x3D;&quot;submit&quot; value&#x3D;&quot;登陆&quot;&gt;</span><br><span class="line">&lt;&#x2F;form&gt;</span><br></pre></td></tr></table></figure>

<p><a href="https://docs.spring.io/spring-security/site/docs/5.3.2.BUILD-SNAPSHOT/reference/html5/" target="_blank" rel="noopener">更多spring-security参阅官方文档</a></p>
<h1 id="六-Spring-boot与分布式"><a href="#六-Spring-boot与分布式" class="headerlink" title="(六) Spring boot与分布式"></a>(六) Spring boot与分布式</h1><h2 id="一、分布式应用"><a href="#一、分布式应用" class="headerlink" title="一、分布式应用"></a>一、分布式应用</h2><p> 分布式应用（distributed application）指的是应用程序分布在不同计算机上，通过网络来共同完成一项任务的工作方式。</p>
<p><strong>为什么需要分布式？</strong></p>
<ul>
<li><p><strong>单一应用架构</strong><br>当网站流量很小时，只需一个应用，将所有功能都部署在一起，以减少部署节点和成本。此时，用于简化增删改查工作量的数据访问框架(ORM)是关键。</p>
</li>
<li><p><strong>垂直应用架构</strong><br>当访问量逐渐增大，单一应用增加机器带来的加速度越来越小，将应用拆成互不相干的几个应用，以提升效率。此时，用于加速前端页面开发的Web框架(MVC)是关键。</p>
</li>
<li><p>分布式服务架构</p>
<p>当垂直应用越来越多，应用之间交互不可避免，将核心业务抽取出来，作为独立的服务，逐渐形成稳定的服务中心，使前端应用能更快速的响应多变的市场需求。此时，用于提高业务复用及整合的分布式服务框架(RPC)是关键。</p>
<ul>
<li><strong>流动计算架构</strong><br>当服务越来越多，容量的评估，小服务资源的浪费等问题逐渐显现，此时需增加一个调度中心基于访问压力实时管理集群容量，提高集群利用率。此时，用于提高机器利用率的资源调度和治理中心(SOA)是关键。</li>
</ul>
</li>
</ul>
<p>在分布式系统中，国内常用zookeeper+dubbo组合，而Spring Boot推荐使用全栈的Spring，Spring Boot+Spring Cloud。</p>
<h2 id="二、Zookeeper和Dubbo"><a href="#二、Zookeeper和Dubbo" class="headerlink" title="二、Zookeeper和Dubbo"></a>二、Zookeeper和Dubbo</h2><h3 id="1-概述-1"><a href="#1-概述-1" class="headerlink" title="1. 概述"></a>1. 概述</h3><p><strong>ZooKeeper</strong><br>ZooKeeper 是一个分布式的，开放源码的分布式应用程序协调服务。它是一个为分布式应用提供一致性服务的软件，提供的功能包括：配置维护、域名服务、分布式同步、组服务等。</p>
<p><strong>Dubbo</strong><br>Dubbo是Alibaba开源的分布式服务框架，它最大的特点是按照分层的方式来架构，使用这种方式可以使各个层之间解耦合（或者最大限度地松耦合）。从服务模型的角度来看，Dubbo采用的是一种非常简单的模型，要么是提供方提供服务，要么是消费方消费服务，所以基于这一点可以抽象出服务提供方（Provider）和服务消费方（Consumer）两个角色。</p>
<h3 id="2-整合springboot"><a href="#2-整合springboot" class="headerlink" title="2. 整合springboot"></a>2. 整合springboot</h3><p><strong>环境搭建</strong></p>
<p>分别创建provider和consumer模块并分别导入依赖</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">       &lt;!-- 导入dubbo与springboot整合启动器 --&gt;</span><br><span class="line">       &lt;dependency&gt;</span><br><span class="line">           &lt;groupId&gt;org.apache.dubbo&lt;&#x2F;groupId&gt;</span><br><span class="line">           &lt;artifactId&gt;dubbo-spring-boot-starter&lt;&#x2F;artifactId&gt;</span><br><span class="line">           &lt;version&gt;2.7.6&lt;&#x2F;version&gt;</span><br><span class="line">       &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">       &lt;!-- 导入zookeeper客户端 --&gt;</span><br><span class="line">       &lt;dependency&gt;</span><br><span class="line">           &lt;groupId&gt;com.github.sgroschupf&lt;&#x2F;groupId&gt;</span><br><span class="line">           &lt;artifactId&gt;zkclient&lt;&#x2F;artifactId&gt;</span><br><span class="line">           &lt;version&gt;0.1&lt;&#x2F;version&gt;</span><br><span class="line">           &lt;exclusions&gt;</span><br><span class="line">               &lt;exclusion&gt;</span><br><span class="line">                   &lt;groupId&gt;org.apache.zookeeper&lt;&#x2F;groupId&gt;</span><br><span class="line">                   &lt;artifactId&gt;zookeeper&lt;&#x2F;artifactId&gt;</span><br><span class="line">               &lt;&#x2F;exclusion&gt;</span><br><span class="line">           &lt;&#x2F;exclusions&gt;</span><br><span class="line">       &lt;&#x2F;dependency&gt;</span><br><span class="line">       &lt;!-- 导入zookeeper客户端所需依赖：curator框架 --&gt;</span><br><span class="line">       &lt;dependency&gt;</span><br><span class="line">           &lt;groupId&gt;org.apache.curator&lt;&#x2F;groupId&gt;</span><br><span class="line">           &lt;artifactId&gt;curator-framework&lt;&#x2F;artifactId&gt;</span><br><span class="line">           &lt;version&gt;4.3.0&lt;&#x2F;version&gt;</span><br><span class="line">       &lt;&#x2F;dependency&gt;</span><br><span class="line">       &lt;dependency&gt;</span><br><span class="line">           &lt;groupId&gt;org.apache.curator&lt;&#x2F;groupId&gt;</span><br><span class="line">           &lt;artifactId&gt;curator-recipes&lt;&#x2F;artifactId&gt;</span><br><span class="line">           &lt;version&gt;4.3.0&lt;&#x2F;version&gt;</span><br><span class="line">       &lt;&#x2F;dependency&gt;</span><br><span class="line">   &lt;&#x2F;dependencies&gt;</span><br></pre></td></tr></table></figure>

<p>provider配置文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 应用项目名</span><br><span class="line">dubbo.application.name&#x3D;provider-ticket</span><br><span class="line"># zookeeper地址</span><br><span class="line">dubbo.registry.address&#x3D;zookeeper:&#x2F;&#x2F;192.168.31.162:2181</span><br><span class="line"># dubbo扫描包路径        </span><br><span class="line">dubbo.scan.base-packages&#x3D;cn.edu.ustc.service</span><br></pre></td></tr></table></figure>

<p>consumer配置文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dubbo.application.name&#x3D;consumer-user</span><br><span class="line">dubbo.registry.address&#x3D;zookeeper:&#x2F;&#x2F;192.168.31.162:2181</span><br></pre></td></tr></table></figure>

<p><strong>生产者服务</strong></p>
<p><code>@EnableDubbo</code> ：</p>
<p>可以在指定的包名下（通过 <code>scanBasePackages</code>），或者指定的类中（通过 <code>scanBasePackageClasses</code>）扫描 Dubbo 的服务提供者（以 <code>@Service</code> 标注）以及 Dubbo 的服务消费者（以 <code>Reference</code> 标注）。</p>
<p><code>@Service</code>：</p>
<p>表示服务的具体实现，被注解的类会被dubbo扫描</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import org.apache.dubbo.config.annotation.Service;</span><br><span class="line">import org.apache.dubbo.config.spring.context.annotation.EnableDubbo;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@EnableDubbo &#x2F;&#x2F;开启对dubbo支持</span><br><span class="line">@Component</span><br><span class="line">@Service &#x2F;&#x2F;标记此类，表示服务的具体实现</span><br><span class="line">public class TicketServiceImpl implements TicketService&#123;</span><br><span class="line">    @Override</span><br><span class="line">    public String getTicket() &#123;</span><br><span class="line">        return &quot;Gxx:合肥-北京&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>消费者服务</strong></p>
<p>编写与分布式服务类相同的接口(不必实现)，并保证包结构相同</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public interface TicketService &#123;</span><br><span class="line">    String getTicket();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@Reference 可以定义在类中的一个字段、方法上，表示一个服务的引用。通常 @Reference 定义在一个字段上</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class UserService &#123;</span><br><span class="line"></span><br><span class="line">    @Reference</span><br><span class="line">    TicketService ticketService;</span><br><span class="line"></span><br><span class="line">    public void hello() &#123;</span><br><span class="line">        String ticket &#x3D; ticketService.getTicket();</span><br><span class="line">        System.out.println(&quot;买到票了:&quot;+ticket);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时若调用<code>hello()</code>,控制台将打印</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">买到票了:Gxx:合肥-北京</span><br></pre></td></tr></table></figure>

<p><strong>有关dubbo更多</strong></p>
<p><a href="http://dubbo.apache.org/zh-cn/blog/dubbo-annotation.html" target="_blank" rel="noopener">dubbo注解详细解释</a></p>
<p><a href="http://dubbo.apache.org/zh-cn/blog/dubbo-zk.html" target="_blank" rel="noopener">dubbo与zookeeper官方整合案例</a></p>
<h2 id="三、Spring-Cloud"><a href="#三、Spring-Cloud" class="headerlink" title="三、Spring Cloud"></a>三、Spring Cloud</h2><h3 id="1-概述-2"><a href="#1-概述-2" class="headerlink" title="1. 概述"></a>1. 概述</h3><p>Spring Cloud是一个分布式的整体解决方案。Spring Cloud 为开发者提供了在分布式系统（配置管理，服务发现，熔断，路由，微代理，控制总线，一次性token，全局琐，leader选举，分布式session，集群状态）中快速构建的工具，使用Spring Cloud的开发者可以快速的启动服务或构建应用、同时能够快速和云平台资源进行对接。</p>
<p>SpringCloud分布式开发五大常用组件</p>
<ul>
<li>服务发现——Netflix Eureka</li>
<li>客服端负载均衡——Netflix Ribbon</li>
<li>断路器——Netflix Hystrix</li>
<li>服务网关——Netflix Zuul</li>
<li>分布式配置——Spring Cloud Config</li>
</ul>
<h3 id="2-入门"><a href="#2-入门" class="headerlink" title="2. 入门"></a>2. 入门</h3><p><strong>Eureka注册中心</strong></p>
<p>创建工程导入<code>eureka-server</code>模块</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">       &lt;dependency&gt;</span><br><span class="line">           &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">           &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-server&lt;&#x2F;artifactId&gt;</span><br><span class="line">       &lt;&#x2F;dependency&gt;</span><br><span class="line">       ...</span><br><span class="line">   &lt;&#x2F;dependencies&gt;</span><br><span class="line"></span><br><span class="line">   &lt;dependencyManagement&gt;</span><br><span class="line">       &lt;dependencies&gt;</span><br><span class="line">           &lt;dependency&gt;</span><br><span class="line">               &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">               &lt;artifactId&gt;spring-cloud-dependencies&lt;&#x2F;artifactId&gt;</span><br><span class="line">               &lt;version&gt;$&#123;spring-cloud.version&#125;&lt;&#x2F;version&gt;</span><br><span class="line">               &lt;type&gt;pom&lt;&#x2F;type&gt;</span><br><span class="line">               &lt;scope&gt;import&lt;&#x2F;scope&gt;</span><br><span class="line">           &lt;&#x2F;dependency&gt;</span><br><span class="line">       &lt;&#x2F;dependencies&gt;</span><br><span class="line">   &lt;&#x2F;dependencyManagement&gt;</span><br></pre></td></tr></table></figure>

<p>配置文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8761</span><br><span class="line">eureka:</span><br><span class="line">  instance:</span><br><span class="line">    hostname: eureka-server  # eureka实例的主机名</span><br><span class="line">  client:</span><br><span class="line">    register-with-eureka: false #不把自己注册到eureka上</span><br><span class="line">    fetch-registry: false #不从eureka上来获取服务的注册信息</span><br><span class="line">    service-url:</span><br><span class="line">      defaultZone: http:&#x2F;&#x2F;localhost:8761&#x2F;eureka&#x2F;</span><br></pre></td></tr></table></figure>

<p><strong>生产者模块</strong></p>
<p>创建工程导入<code>eureka-client</code>和<code>web</code>模块</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">    ...</span><br><span class="line">&lt;&#x2F;dependencies&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependencyManagement&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-dependencies&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;spring-cloud.version&#125;&lt;&#x2F;version&gt;</span><br><span class="line">            &lt;type&gt;pom&lt;&#x2F;type&gt;</span><br><span class="line">            &lt;scope&gt;import&lt;&#x2F;scope&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;&#x2F;dependencies&gt;</span><br><span class="line">&lt;&#x2F;dependencyManagement&gt;</span><br></pre></td></tr></table></figure>

<p>配置文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8002</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: provider-ticket</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">eureka:</span><br><span class="line">  instance:</span><br><span class="line">    prefer-ip-address: true # 注册服务的时候使用服务的ip地址</span><br><span class="line">  client:</span><br><span class="line">    service-url:</span><br><span class="line">      defaultZone: http:&#x2F;&#x2F;localhost:8761&#x2F;eureka&#x2F;</span><br></pre></td></tr></table></figure>

<p>编写controller层和service层demo</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class TicketService &#123;</span><br><span class="line">    public String getTicket()&#123;</span><br><span class="line">        System.out.println(&quot;8002&quot;);</span><br><span class="line">        return &quot;《厉害了，我的国》&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@RestController</span><br><span class="line">public class TicketController &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    TicketService ticketService;</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;&#x2F;ticket&quot;)</span><br><span class="line">    public String getTicket()&#123;</span><br><span class="line">        return ticketService.getTicket();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>消费者模块</strong></p>
<p>创建工程导入<code>eureka-client</code>和<code>web</code>模块</p>
<p>配置文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: consumer-user</span><br><span class="line">server:</span><br><span class="line">  port: 8200</span><br><span class="line"></span><br><span class="line">eureka:</span><br><span class="line">  instance:</span><br><span class="line">    prefer-ip-address: true # 注册服务的时候使用服务的ip地址</span><br><span class="line">  client:</span><br><span class="line">    service-url:</span><br><span class="line">      defaultZone: http:&#x2F;&#x2F;localhost:8761&#x2F;eureka&#x2F;</span><br></pre></td></tr></table></figure>

<p>向容器中注入<code>RestTemplate</code>, 并使用<code>@EnableDiscoveryClient</code>开启发现服务功能</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@EnableDiscoveryClient &#x2F;&#x2F;开启发现服务功能</span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class ConsumerUserApplication &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(ConsumerUserApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @LoadBalanced &#x2F;&#x2F;使用负载均衡机制</span><br><span class="line">    @Bean</span><br><span class="line">    public RestTemplate restTemplate()&#123;</span><br><span class="line">        return new RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写controller并使用<code>RestTemplate</code>发现服务</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class UserController &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;&#x2F;buy&quot;)</span><br><span class="line">    public String buyTicket(String name)&#123;</span><br><span class="line">        String s &#x3D; restTemplate.getForObject(&quot;http:&#x2F;&#x2F;PROVIDER-TICKET&#x2F;ticket&quot;, String.class);</span><br><span class="line">        return name+&quot;购买了&quot;+s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>向<code>http://localhost:8200/buy?username=zhangsan</code>发请求，则会响应</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">zhangsan购买了《厉害了，我的国》</span><br></pre></td></tr></table></figure>

<p>并且在使用了<code>@LoadBalanced</code>之后实现了负载均衡，如果创建不同端口的<code>provider</code>应用，则访问会被均衡到各个应用</p>
<h1 id="七-Spring-boot与热部署"><a href="#七-Spring-boot与热部署" class="headerlink" title="(七) Spring boot与热部署"></a>(七) Spring boot与热部署</h1><p>在开发中我们修改一个Java文件后想看到效果不得不重启应用，这导致大量时间花费，我们希望不重启应用的情况下，程序可以自动部署（热部署）。有以下四种情况，如何能实现热部署。</p>
<h2 id="一、模板引擎"><a href="#一、模板引擎" class="headerlink" title="一、模板引擎"></a>一、模板引擎</h2><p>在Spring Boot中开发情况下禁用模板引擎的cache<br>页面模板改变ctrl+F9可以重新编译当前页面并生效</p>
<h2 id="二、Spring-Loaded"><a href="#二、Spring-Loaded" class="headerlink" title="二、Spring Loaded"></a>二、Spring Loaded</h2><p>Spring官方提供的热部署程序，实现修改类文件的热部署</p>
<ul>
<li>下载Spring Loaded（项目地址<a href="https://github.com/spring-projects/spring-loaded）" target="_blank" rel="noopener">https://github.com/spring-projects/spring-loaded）</a></li>
<li>添加运行时参数；<ul>
<li>javaagent:C:/springloaded-1.2.5.RELEASE.jar –noverify</li>
</ul>
</li>
</ul>
<h2 id="三、JRebel"><a href="#三、JRebel" class="headerlink" title="三、JRebel"></a>三、JRebel</h2><p>收费的一个热部署软件<br>安装插件使用即可</p>
<h2 id="四、-Spring-Boot-Devtools（推荐）"><a href="#四、-Spring-Boot-Devtools（推荐）" class="headerlink" title="四、 Spring Boot Devtools（推荐）"></a>四、 Spring Boot Devtools（推荐）</h2><p>引入依赖</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-devtools&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<p>IDEA使用ctrl+F9重新编译实现热部署</p>
<h1 id="八-Spring-Boot与监控管理"><a href="#八-Spring-Boot与监控管理" class="headerlink" title="(八) Spring Boot与监控管理"></a>(八) Spring Boot与监控管理</h1><p>通过引入spring-boot-starter-actuator，可以使用Spring Boot为我们提供的准生产环境下的应用监控和管理功能。我们可以通过HTTP，JMX，SSH协议来进行操作，自动得到审计、健康及指标信息等</p>
<h2 id="一、-Actuator监控管理"><a href="#一、-Actuator监控管理" class="headerlink" title="一、 Actuator监控管理"></a>一、 Actuator监控管理</h2><p><strong>导入依赖</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-actuator&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<p>浏览器打开链接<code>http://localhost:8080/actuator/</code>,可以看到所有支持的连接，响应如下,默认只支持这些端点</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;_links&quot;: &#123;</span><br><span class="line">        &quot;self&quot;: &#123;</span><br><span class="line">            &quot;href&quot;: &quot;http:&#x2F;&#x2F;localhost:8080&#x2F;actuator&quot;,</span><br><span class="line">            &quot;templated&quot;: false</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;health&quot;: &#123;</span><br><span class="line">            &quot;href&quot;: &quot;http:&#x2F;&#x2F;localhost:8080&#x2F;actuator&#x2F;health&quot;,</span><br><span class="line">            &quot;templated&quot;: false</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;health-path&quot;: &#123;</span><br><span class="line">            &quot;href&quot;: &quot;http:&#x2F;&#x2F;localhost:8080&#x2F;actuator&#x2F;health&#x2F;&#123;*path&#125;&quot;,</span><br><span class="line">            &quot;templated&quot;: true</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;info&quot;: &#123;</span><br><span class="line">            &quot;href&quot;: &quot;http:&#x2F;&#x2F;localhost:8080&#x2F;actuator&#x2F;info&quot;,</span><br><span class="line">            &quot;templated&quot;: false</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果要看到所有支持的状态查询，需要配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">management.endpoints.web.exposure.include&#x3D;*</span><br></pre></td></tr></table></figure>

<p>bean加载情况<code>http://localhost:8080/actuator/beans</code>,显示了容器中各类各项属性</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;contexts&quot;: &#123;</span><br><span class="line">        &quot;application&quot;: &#123;</span><br><span class="line">            &quot;beans&quot;: &#123;</span><br><span class="line">                &quot;endpointCachingOperationInvokerAdvisor&quot;: &#123;</span><br><span class="line">                    &quot;aliases&quot;: [],</span><br><span class="line">                    &quot;scope&quot;: &quot;singleton&quot;,</span><br><span class="line">                    &quot;type&quot;: &quot;org.springframework.boot.actuate.endpoint.invoker.cache.CachingOperationInvokerAdvisor&quot;,</span><br><span class="line">                    &quot;resource&quot;: &quot;class path resource [org&#x2F;springframework&#x2F;boot&#x2F;actuate&#x2F;autoconfigure&#x2F;endpoint&#x2F;EndpointAutoConfiguration.class]&quot;,</span><br><span class="line">                    &quot;dependencies&quot;: [</span><br><span class="line">                        &quot;environment&quot;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;defaultServletHandlerMapping&quot;: &#123;</span><br><span class="line">                    &quot;aliases&quot;: [],</span><br><span class="line">                    &quot;scope&quot;: &quot;singleton&quot;,</span><br><span class="line">                    &quot;type&quot;: &quot;org.springframework.web.servlet.HandlerMapping&quot;,</span><br><span class="line">                    &quot;resource&quot;: &quot;class path resource [org&#x2F;springframework&#x2F;boot&#x2F;autoconfigure&#x2F;web&#x2F;servlet&#x2F;WebMvcAutoConfiguration$EnableWebMvcConfiguration.class]&quot;,</span><br><span class="line">                    &quot;dependencies&quot;: []</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br></pre></td></tr></table></figure>

<h2 id="二、-端点配置"><a href="#二、-端点配置" class="headerlink" title="二、 端点配置"></a>二、 端点配置</h2><p>默认情况下，除shutdown以外的所有端点均已启用。要配置单个端点的启用，请使用<code>management.endpoint..enabled</code>属性。以下示例启用<code>shutdown</code>端点：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">management.endpoint.shutdown.enabled&#x3D;true</span><br></pre></td></tr></table></figure>

<p>另外可以通过<code>management.endpoints.enabled-by-default</code>来修改全局端口默认配置,以下示例启用info端点并禁用所有其他端点：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">management.endpoints.enabled-by-default&#x3D;false</span><br><span class="line">management.endpoint.info.enabled&#x3D;true</span><br></pre></td></tr></table></figure>

<p>修改路径</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 修改根目录路径</span><br><span class="line">management.endpoints.web.base-path&#x3D;&#x2F;management</span><br><span class="line"># 修改&#x2F;health路径</span><br><span class="line">management.endpoints.web.path-mapping.health&#x3D;healthcheck</span><br></pre></td></tr></table></figure>

<p><a href="https://docs.spring.io/spring-boot/docs/2.2.6.RELEASE/reference/html/production-ready-features.html#production-ready-endpoints" target="_blank" rel="noopener">更多参阅spring-actuator官方文档</a></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">陈涛</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://somunstao.github.io/2020/03/30/SpringBoot22%EF%BC%9A%E9%9B%B7%E7%A5%9E%E7%AC%94%E8%AE%B0%E9%AB%98%E7%BA%A7/">https://somunstao.github.io/2020/03/30/SpringBoot22：雷神笔记高级/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://SomunsTao.github.io" target="_blank">Somuns ` Tao</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SpringBoot/">SpringBoot</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/03/30/SpringBoot20%EF%BC%9A%E5%B0%8F%E6%80%BB%E7%BB%93/"><img class="prev_cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">SpringBoot：小总结</div></div></a></div><div class="next-post pull_right"><a href="/2020/03/30/SpringBoot22%EF%BC%9A%E9%9B%B7%E7%A5%9E%E7%AC%94%E8%AE%B0(%E5%88%9D%E7%BA%A7)/"><img class="next_cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">SpringBoot：雷神笔记</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/03/02/SpringBoot02：运行原理初探/" title="SpringBoot02：运行原理初探"><img class="relatedPosts_cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-02</div><div class="relatedPosts_title">SpringBoot02：运行原理初探</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/03/SpringBoot03：yaml配置注入/" title="SpringBoot03：yaml配置注入"><img class="relatedPosts_cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-03</div><div class="relatedPosts_title">SpringBoot03：yaml配置注入</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/04/SpringBoot04：JSR303数据校验及多环境切换/" title="SpringBoot04：JSR303数据校验及多环境切换"><img class="relatedPosts_cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-04</div><div class="relatedPosts_title">SpringBoot04：JSR303数据校验及多环境切换</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/05/SpringBoot05：自动配置原理/" title="SpringBoot05：自动配置原理"><img class="relatedPosts_cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-05</div><div class="relatedPosts_title">SpringBoot05：自动配置原理</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/06/SpringBoot06：自定义starter/" title="SpringBoot06：自定义starter"><img class="relatedPosts_cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-06</div><div class="relatedPosts_title">SpringBoot06：自定义starter</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/07/SpringBoot07：整合JDBC/" title="SpringBoot07：整合JDBC"><img class="relatedPosts_cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-07</div><div class="relatedPosts_title">SpringBoot07：整合JDBC</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="lv-container" data-id="city" data-uid="MTAyMC80OTk1Ni8yNjQ0Nw=="><script>(function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
})(document, 'script');</script></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By 陈涛</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">簡</a><i class="darkmode far fa-moon" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script defer id="ribbon" src="/js/third-party/canvas-ribbon.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="true"></script><script id="ribbon_piao" mobile="true" src="/js/third-party/piao.js"></script><script id="canvas_nest" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="true" src="/js/third-party/canvas-nest.js"></script><script src="/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
document.body.addEventListener('input', POWERMODE);
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="/js/third-party/click_heart.js"></script></body></html>